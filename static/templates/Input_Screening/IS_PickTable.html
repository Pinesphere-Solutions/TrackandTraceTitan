{% extends "base.html" %} {% load static %} {% block content %}
<style>
/* Professional table header styling with proper text wrapping */
#order-listing th {
  position: relative;
  padding: 8px 12px 8px 16px !important;
  text-align: left !important;
  vertical-align: middle !important;
  white-space: normal !important;
  line-height: 1.3 !important;
  word-break: keep-all !important;
  hyphens: none !important;
  font-size: 13px !important;
  font-weight: 600 !important;
  background: #028084 !important;
  color: #e5fcff !important;
  border-bottom: 2.5px solid #bdbdbd !important;
  min-width: 80px;
  max-width: 140px;
}


/* Specific width adjustments for better text wrapping */
#order-listing th:nth-child(1) { min-width: 50px; max-width: 60px; }   /* S.No */
#order-listing th:nth-child(2) { min-width: 90px; max-width: 110px; }  /* Last Updated */
#order-listing th:nth-child(3) { min-width: 100px; max-width: 120px; } /* Plating Stk No */
#order-listing th:nth-child(4) { min-width: 115px; max-width: 130px; } /* Polishing Stk No */
#order-listing th:nth-child(5) { min-width: 90px; max-width: 110px; }  /* Plating Color */
#order-listing th:nth-child(6) { min-width: 80px; max-width: 100px; }  /* Category */
#order-listing th:nth-child(7) { min-width: 90px; max-width: 110px; }  /* Polish Finish */
#order-listing th:nth-child(8) { min-width: 110px; max-width: 140px; } /* Tray Cate-Capacity */
#order-listing th:nth-child(9) { min-width: 90px; max-width: 110px; }  /* Input Source */
#order-listing th:nth-child(10) { min-width: 80px; max-width: 100px; } /* No of Trays */
#order-listing th:nth-child(11) { min-width: 70px; max-width: 90px; }  /* LOT Qty */
#order-listing th:nth-child(12) { min-width: 90px; max-width: 100px; } /* Physical Qty */
#order-listing th:nth-child(13) { min-width: 80px; max-width: 100px; } /* IPA Wiping */
#order-listing th:nth-child(14) { min-width: 80px; max-width: 100px; } /* Accept Qty */
#order-listing th:nth-child(15) { min-width: 80px; max-width: 100px; } /* Reject Qty */
#order-listing th:nth-child(16) { min-width: 120px; max-width: 130px; } /* Process Status */
#order-listing th:nth-child(17) { min-width: 80px; max-width: 100px; } /* Action */
#order-listing th:nth-child(18) { min-width: 90px; max-width: 110px; } /* Lot Status */
#order-listing th:nth-child(19) { min-width: 100px; max-width: 120px; } /* Current Stage */
#order-listing th:nth-child(20) { min-width: 90px; max-width: 100px; } /* Remarks */
 
/* Right-align filter icons */
#order-listing th .fa-filter {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 11px;
  opacity: 0.7;
  cursor: pointer;
  transition: opacity 0.2s;
}

#order-listing th .fa-filter:hover {
  opacity: 1;
}
/* Special handling for Process Status column to prevent overlap */
#order-listing th:nth-child(16) {
  padding-right: 25px !important; /* Extra padding for filter icon */
  position: relative;
}

#order-listing th:nth-child(16) .fa-filter {
  right: 4px; /* Closer to edge */
  top: 15px; /* Move to top instead of center */
  transform: none; /* Remove centering transform */
}

/* Ensure Process Status column content doesn't overlap with filter */
#order-listing td:nth-child(16) .process-status-group {
  margin-right: 20px; /* Space for filter icon */
}

/* Better text wrapping for specific headers */
#order-listing th {
  overflow-wrap: break-word;
  word-wrap: break-word;
}
/* Add backdrop overlay when tooltip is visible */
.model-hover-trigger:hover::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.3);
  z-index: 100000 !important;
  pointer-events: none;
}
 /* Hide frozen columns when tooltip is visible */
.model-hover-trigger:hover ~ * #order-listing th:nth-child(1),
.model-hover-trigger:hover ~ * #order-listing td:nth-child(1),
.model-hover-trigger:hover ~ * #order-listing th:nth-child(3),
.model-hover-trigger:hover ~ * #order-listing td:nth-child(3) {
  z-index: 1 !important;
}
/* Override tooltip to show at center of screen with full image view */
.model-hover-trigger .model-image-tooltip {
  position: fixed !important;
  left: 50% !important;
  top: 50% !important;
  transform: translate(-50%, -50%) !important;
  width: 50vw !important;
  height: 50vh !important;
  max-width: 400px !important;
  max-height: 300px !important;
  background: rgba(243, 243, 243, 0.95) !important;
  border: none !important;
  border-radius: 12px !important;
  padding: 20px !important;
  z-index: 100001 !important;
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  justify-content: center !important;
  gap: 0 !important;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
  pointer-events: auto !important;
}
/* Lower z-index of frozen columns during hover */
.model-hover-trigger:hover {
  position: relative;
  z-index: 100002 !important;
}

/* Force all sticky elements to have lower z-index when hovering */
.model-hover-trigger:hover ~ * [style*="position: sticky"],
.model-hover-trigger:hover ~ * [style*="z-index"] {
  z-index: 1 !important;
}

/* Ensure close and info buttons are above everything */
.model-image-tooltip::before {
  content: '×';
  position: absolute;
  top: 15px;
  right: 15px;
  width: 40px;
  height: 40px;
  background: #dc3545;
  color: white;
  border: none;
  border-radius: 50%;
  font-size: 24px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 100001 !important; /* Higher than tooltip */
  box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
  transition: all 0.3s ease;
}
/* Adjust close and info buttons for smaller tooltip */
.model-image-tooltip::before,
.model-image-tooltip::after {
  width: 30px !important;
  height: 30px !important;
  font-size: 18px !important;
  top: 10px !important;
   z-index: 100002 !important;
  opacity: 1 !important;
  filter: none !important;
}
.model-image-tooltip::after {
  content: 'ℹ';
  position: absolute;
  top: 15px;
  left: 15px;
  width: 40px;
  height: 40px;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 50%;
  font-size: 18px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 100001 !important; /* Higher than tooltip */
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
  transition: all 0.3s ease;
}
.model-image-tooltip {
  padding: 15px !important;
}
.model-hover-trigger:hover .model-image-tooltip {
  opacity: 1 !important;
  visibility: visible !important;
  pointer-events: auto !important;
  z-index: 100003 !important;
}

/* Reduce visibility of table background during hover */
.model-hover-trigger:hover ~ tr,
.model-hover-trigger:hover ~ td {
  opacity: 0.3 !important;
}

/* Hide sticky elements during hover */
tbody tr:has(.model-hover-trigger:hover) ~ tr {
  opacity: 0.2 !important;
}
/* Hide scroll buttons in tooltip */
.model-image-tooltip .img-scroll-left,
.model-image-tooltip .img-scroll-right {
  display: none !important;
}

/* Style the image gallery for center display */
.model-image-tooltip .img-gallery {
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  width: 100% !important;
  height: calc(100% - 60px) !important;
  overflow: hidden !important;
  position: relative !important;
}

/* Show only first image and make it full size */
.model-image-tooltip .img-gallery img {
  width: 100% !important;
  height: 100% !important;
  object-fit: contain !important;
  border-radius: 8px !important;
  box-shadow: 0 8px 32px rgba(255, 255, 255, 0.1) !important;
  display: none !important;
}

.model-image-tooltip .img-gallery img:first-child {
  display: block !important;
  width: 100% !important;
  height: 100% !important;
  object-fit: contain !important;
  opacity: 1 !important;
  filter: none !important;
}

/* Hover effects for buttons */
.model-image-tooltip:hover::before {
  background: #c82333;
  transform: scale(1.1);
}

.model-image-tooltip:hover::after {
  background: #0056b3;
  transform: scale(1.1);
}

/* Hide tooltip when clicking close area */
.model-hover-trigger.tooltip-closed .model-image-tooltip {
  opacity: 0 !important;
  visibility: hidden !important;
  pointer-events: none !important;
}

.pagination-wrapper {
  position: fixed;
  bottom: 30px; /* Adjust to place it above the footer */
  left: 0;
  width: 100%;
  background: #f5f7ff; /* Optional: Background color */
  z-index: 1000; /* Ensure it stays above other elements */
  display: flex;
  justify-content: center;
  padding: 10px 0; /* Add padding for better spacing */
  box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1); /* Optional shadow for better separation */
}

@media (max-width: 600px) {
  .pagination-wrapper {
    bottom: 50px; /* Adjust for smaller screens */
    padding: 5px 0;
    margin-left: 4px !important;
  }
}

.pagination .page-link {
  padding: 2px 8px !important;
  font-size: 13px !important;
  min-width: 28px !important;
  min-height: 28px !important;
}

/* Freeze S.No (first column) data */
#order-listing tbody td:nth-child(1) {
  position: sticky !important;
  left: 0 !important;
  z-index:1 !important; /* Ensure it stays above other rows */
}

/* Freeze Plating Stk No (third column) data */
#order-listing tbody td:nth-child(3) {
  position: sticky;
  left: 180px; /* Adjust based on the cumulative width of previous columns */
  z-index: 15; /* Ensure it stays above other rows */
  background: #fff; /* Match the background color */
}

/* Freeze S.No (first column) */
#order-listing th:nth-child(1),
#order-listing td:nth-child(1) {
  position: sticky;
  left: 0;
  z-index: 20;
  background: #fff;
  min-width: 80px;
  box-shadow: 2px 0 2px -1px rgba(0, 0, 0, 0.04);
}

#order-listing th:nth-child(2){
  z-index: 25 !important ;
}

/* Freeze Date and Time (second column) */
#order-listing th:nth-child(2),
#order-listing td:nth-child(2) {
  position: sticky;
  left: 80px; /* width of col 1 */
  z-index: 0;
  background: #fff;
  min-width: 100px;
  box-shadow: 2px 0 2px -1px rgba(0, 0, 0, 0.03);
  word-break: break-word;
  white-space: normal;
  text-align: center;
}

/* Freeze Plating Stk No (third column) */
#order-listing th:nth-child(3),
#order-listing td:nth-child(3) {
  position: sticky;
  left: 180px; /* 80px (col 1) + 100px (col 2) */
  z-index: 20;
  background: #fff;
  min-width: 100px;
  box-shadow: -1px 0 2px rgba(0, 0, 0, 0.1); /* Optional shadow for better separation */
}

/* Sticky Header Row */
thead th {
  position: sticky;
  top: 0;
  background-color: white; /* or your table header bg color */
  z-index: 10; /* ensure it stays above the table rows */
  box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.4); /* optional shadow for better separation */
  height: 38px !important; /* Increase as needed */
  background: #028084 !important; /* existing bg */
  color: #e5fcff !important;      /* existing color */
  vertical-align: middle !important;
}

.fixed-bottom-element {
  position: static !important; /* Ensure it's static */
  margin-top: 635px !important; /* Adjust the margin from the top */
  width: 100%; /* Optional: Make it span the full width */
  z-index: 2; /* Ensure it stays above other elements if needed */
}

/* --- Stylish Circle Pagination --- */
.pagination {
  display: flex;
  gap: 8px;
  justify-content: center;
  align-items: center;
  padding: 0;
  margin: 0;
  background: none;
}

.pagination li {
  list-style: none;
}

.pagination li a,
.pagination li span {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #f0f6fa;
  color: #028084;
  font-weight: 600;
  font-size: 15px;
  border: 2px solid transparent;
  transition: background 0.2s, color 0.2s, border 0.2s;
  text-decoration: none;
  box-shadow: 0 2px 8px rgba(2,128,132,0.06);
  margin: 0 2px;
}

.pagination li a:hover,
.pagination li:not(.active):not(.disabled) a:focus {
  background: #028084;
  color: #fff;
  border-color: #028084;
}

.pagination li.active span {
  background: #028084;
  color: #fff;
  border-color: #028084;
  cursor: default;
  box-shadow: 0 4px 12px rgba(2,128,132,0.13);
}

.pagination li.disabled span {
  background: #e0e0e0;
  color: #bdbdbd;
  cursor: not-allowed;
  border-color: #e0e0e0;
}

.pagination li .page-link {
  border: none;
  background: none;
  box-shadow: none;
  padding: 0;
}

.pagination li .fa {
  font-size: 18px;
  vertical-align: middle;
}

/* Responsive: smaller circles on mobile */
@media (max-width: 600px) {
  .pagination li a,
  .pagination li span {
    width: 28px;
    height: 28px;
    font-size: 13px;
  }
}

/* End of pagination styles */
/* Reduce the width of the Delink table */
.delink-table-container {
  max-width: 600px; /* Set the desired width */
  margin: 0 auto; /* Center the table horizontally */
}

.delink-table-container table {
  width: 90%; /* Ensure the table fits within the container */
  border: solid 1px black;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.delink-table-container th,
.delink-table-container td {
  padding: 12px;
  text-align: center;
}

.modal-top-header h6 {
  margin-top: 10px;
}

/* Increase the width of the new-popup-modal when open */
.new-popup-modal.open {
  width: 500px; /* Set the desired width */
  right: 0; /* Ensure it slides in from the right */
  transition: width 0.3s ease, right 0.3s ease; /* Smooth transition */
}

/* Style for toggle switch and whole row inactive */
@media (max-width: 426px){
  .file-upload-area p {
    font-size: 12px !important;
  }
}

.tooltip-inner {
  white-space: pre-line !important;
}

td:first-child,
td:first-child * {
  filter: none !important;
  opacity: 1 !important;
  pointer-events: auto !important;
  color: inherit !important;
}

.row-inactive,
.row-inactive td {
  background: #ededed !important;
  background-color: #ededed !important;
}

.row-inactive td:first-child {
  background: none !important;
  background-color: transparent !important;
}

.row-inactive-blur {
  filter: blur(0.7px);
  cursor: not-allowed !important;
  user-select: none;
  pointer-events: auto; /* allow hover for cursor effect */
}

.hold-toggle-switch {
  position: relative;
  display: inline-block;
  width: 36px;
  height: 20px;
}

.hold-toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.hold-slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: #e5e5e5; /* Always grey track */
  border-radius: 20px;
  transition: .3s;
}

.hold-slider:before {
  position: absolute;
  content: "";
  height: 16px; width: 16px;
  left: 2px; bottom: 2px;
  background-color: #bbb; /* Default grey circle */
  border: 2px solid #bbb;
  border-radius: 50%;
  transition: .3s;
}

.hold-toggle-switch input:checked + .hold-slider:before {
  transform: translateX(16px);
  background-color: #007bff; /* Blue circle when ON */
  border-color: #007bff;
}

.hold-toggle-switch input:not(:checked) + .hold-slider:before {
  background-color: #bbb; /* Grey circle when OFF */
  border-color: #bbb;
}

.hold-toggle-switch input:disabled + .hold-slider:before {
  background-color: #bbb !important; /* Grey circle when disabled */
  border-color: #bbb !important;
}

/* end of toggle style switch */

/* Zoom animation for modal user profile image */
.modal-top-header img {
  transition: transform 0.3s cubic-bezier(.4,2,.3,1), box-shadow 0.3s;
  will-change: transform;
  cursor: pointer;
}

.modal-top-header img:hover {
  transform: scale(1.18) rotate(-2deg);
  box-shadow: 0 4px 24px rgba(2,128,132,0.18);
  z-index: 10;
}

/* Day Planning Tray Scan Modal Styles */
.dp-row-action-highlight {
  background-color: #f0f8ff !important; /* Light blue, or pick your color */
  transition: background 0.3s;
}

/* Show tooltip on hover */
.model-hover-trigger:hover .model-image-tooltip {
  opacity: 1 !important;
  pointer-events: auto !important;
  display: flex !important;
}

.readonly-modal-header {
  background: #f3f3f3;
  border-radius: 8px 8px 0 0;
  padding: 16px 20px 12px 20px !important;
  margin-bottom: 10px;
  align-items: flex-end !important;
}

.readonly-modal-header .user-profile {
  display: flex;
  align-items: flex-end;
  gap: 8px;
}

#modalModelNo_DayPlanning {
  margin-top: 10px !important;
  display: inline-block;
  font-weight: 600;
  color: #028084;
}

/* Dim or blur main content when read-only tray scan modal is open */
.tray-scan-modal-DayPlanning.open ~ .content-wrapper {
  opacity: 0.3;
  pointer-events: none;
  /* For blur effect, use the next line instead of opacity: */
  /* filter: blur(2px); */
}

/* Shrink table row height in read-only tray scan modal */
#trayScanModal_DayPlanning table tr,
#trayScanModal_DayPlanning table td,
#trayScanModal_DayPlanning table th {
  height: 22px !important;
  padding-top: 2px !important;
  padding-bottom: 2px !important;
  padding-left: 6px !important;
  padding-right: 6px !important;
  font-size: 12px !important;
}

#trayScanModal_DayPlanning input.form-control {
  height: 22px !important;
  padding: 2px 6px !important;
  font-size: 12px !important;
}

.tray-scan-modal-DayPlanning {
  display: none;
  position: fixed;
  top: 40px;
  right: 20px;
  width: 600px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  padding: 20px;
  z-index: 10000;
  max-height: 90vh;
  overflow-y: auto;
}

.tray-scan-modal-DayPlanning.open {
  display: block;
}

.tray-scan-close-readonly {
  position: absolute;
  top: 18px;
  right: 10px;
  font-size: 24px;
  font-weight: bold;
  cursor: pointer;
  color: #d9534f;
}

#trayScanDetails.table-grid > div {
  overflow: visible !important;
  min-width: 0 !important;
  word-break: break-all;
}

.tray-scan-modal h5 {
  text-align: center !important;
  margin: 0 auto 8px auto !important;
  font-size: 1.15rem !important;
  font-weight: 600 !important;
  width: 100%;
  display: block;
}

#trayScanDetails.table-grid > div.tray-validation-status-header {
  background-color: #e0f7fa !important;
  font-weight: bold !important;
  color: #028084 !important;
}

#trayScanDetails.table-grid > div.tray-validation-status-cell {
  background-color: #f1fcff !important;
  font-weight: bold !important;
  color: #028084 !important;
}

/* Modal header improvements */
.modal-top-header {
  display: flex;
  align-items: center;
  gap: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid #e9ecef;
  margin-bottom: 20px;
  margin-top: 15px;
}

/* Button styling improvements */
#trayValidateBtn {
  display: flex;
  align-items: center;
  gap: 8px;
  background: #f5faff;
  border: 1px solid #007bff;
  color: #007bff;
  border-radius: 25px;
  padding: 8px 18px;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}

#trayValidateBtn:hover {
  background: #e3f2fd;
  border-color: #0056b3;
  color: #0056b3;
  transform: translateY(-1px);
}

#trayScanRedoBtn {
  width: 32px;
  height: 32px;
  cursor: pointer;
  border-radius: 6px;
  padding: 4px;
  transition: all 0.2s ease;
}

#trayScanRedoBtn:hover {
  background: rgba(0, 0, 0, 0.1);
  transform: scale(1.1);
}

/* Error message styling */
#trayErrorMessage {
  background-color: #f8d7da;
  border: 1px solid #f5c6cb;
  color: #721c24;
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 15px;
  font-size: 12px;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Override grid display for table layout */
#trayScanDetails_DayPlanning.table-grid {
  display: block !important;    /* Override grid display */
  grid-template-columns: none !important;
  gap: 0 !important;
  max-height: none !important;
  overflow-y: visible !important;
  padding-right: 0;
  margin-top: 0;
  background: #fff;
  position: relative;
}

/* Remove grid cell styling when using table */
#trayScanDetails_DayPlanning.table-grid > div {
  display: none !important;     /* Hide grid divs when table is used */
}

/* Professional Validation Status Icons Styling */
.validation-status {
  display: flex;
  align-items: center;
  gap: 8px;
  justify-content: center;
  padding: 4px;
}

.status-icon {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  cursor: default;
}

/* Default state - both icons visible but dimmed */
.status-icon.fail,
.status-icon.pass {
  opacity: 0.25;
  filter: grayscale(0.8) brightness(0.7);
  transform: scale(0.9);
  border: 1px solid transparent;
}

/* Pass icon styling */
.status-icon.pass {
  background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
}

.status-icon.pass img {
  filter: hue-rotate(0deg) saturate(0.6);
}

/* Fail icon styling */
.status-icon.fail {
  background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
}

.status-icon.fail img {
  filter: hue-rotate(0deg) saturate(0.6);
}

/* Active states */
.status-icon.active {
  opacity: 1 !important;
  filter: grayscale(0) brightness(1) !important;
  transform: scale(1.15) !important;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
  border: 2px solid !important;
  animation: statusActivate 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.status-icon.active.pass {
  background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%) !important;
  border-color: #2e7d32 !important;
  box-shadow: 0 4px 16px rgba(76, 175, 80, 0.4) !important;
}

.status-icon.active.pass img {
  filter: brightness(0) invert(1) !important; /* Makes icon white */
}

.status-icon.active.fail {
  background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%) !important;
  border-color: #d32f2f !important;
  box-shadow: 0 4px 16px rgba(244, 67, 54, 0.4) !important;
}

.status-icon.active.fail img {
  filter: brightness(0) invert(1) !important; /* Makes icon white */
}

/* Inactive state - more subtle */
.status-icon.inactive {
  opacity: 0.15 !important;
  filter: grayscale(1) brightness(0.5) !important;
  transform: scale(0.8) !important;
}

/* Animation for activation */
@keyframes statusActivate {
  0% {
    transform: scale(0.9);
    opacity: 0.3;
  }
  50% {
    transform: scale(1.25);
    opacity: 0.8;
  }
  100% {
    transform: scale(1.15);
    opacity: 1;
  }
}

/* Hover effects for better UX */
.status-icon:not(.active):hover {
  opacity: 0.4 !important;
  filter: grayscale(0.5) brightness(0.8) !important;
  transform: scale(0.95) !important;
  transition: all 0.2s ease !important;
}

/* Center and style the tray scan table title */
@media (min-width: 1800px) and (max-width: 2000px) and (min-height: 1100px) and (max-height: 1300px) {
  #order-listing,
  #order-listing th,
  #order-listing td {
    font-size: 14px !important;
    font-weight: 500 !important;
  }
  
  .content-wrapper,
  .row,
  .col-12,
  .grid-margin,
  .stretch-card,
  .card,
  .card-body,
  .table-responsive,
  #order-listing {
    max-width: 1400px !important;
    margin-left: auto !important;
    margin-right: auto !important;
    width: 100% !important;
  }
  
  .card {
    min-height: 700px !important;
  }
  
  .card-body {
    min-height: 650px !important;
    padding: 0 !important;
    margin-right: 0 !important;
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
  }
  
  #order-listing tr,
  #order-listing td,
  #order-listing th {
    height: 44px !important;
    min-height: 44px !important;
  }
}

@media (min-width: 600px) and (max-width: 1024px) {
  #order-listing,
  #order-listing th,
  #order-listing td {
    font-size: 14px !important;
    font-weight: 400 !important;
  }
}

#order-listing,
#order-listing th,
#order-listing td {
  font-size: 12px !important;
  font-weight: 600 !important;
}

body.sidebar-icon-only .main-panel,
body.sidebar-icon-only .content-wrapper,
body.sidebar-icon-only .card,
body.sidebar-icon-only .card-body,
body.sidebar-icon-only .table-responsive {
  margin-left: 0 !important;
  padding-left: 0 !important;
  width: 100% !important;
  max-width: 100% !important;
  box-sizing: border-box !important;
}

.content-wrapper,
.card,
.card-body,
.table-responsive {
  width: 100% !important;
  max-width: 100% !important;
  margin-right: 0 !important;
  /* padding-right: 0 !important; */
  box-sizing: border-box !important;
}

/* Remove right space after the table and make table stretch fully */
.content-wrapper,
.row,
.col-12,
.grid-margin,
.stretch-card,
.card,
.card-body,
.table-responsive,
#order-listing {
  margin-right: 0 !important;
  padding-right: 0 !important;
  box-sizing: border-box !important;
}

body, html {
  overflow-x: hidden !important;
  height: 100%;
  margin: 0;
  padding: 0;
  overflow: hidden;
}

/* Remove left/right padding from .row and .col-12 if any */
.row,
.col-12 {
  padding-left: 0 !important;
  padding-right: 0 !important;
  margin-left: 0 !important;
  margin-right: 0 !important;
}

/* Remove min-width from table if not needed */
#order-listing {
  min-width: 0 !important;
  min-width: unset !important;
  max-width: 100% !important;
  margin-bottom: 0 !important;
  border-collapse: collapse;
}

#order-listing th,
#order-listing td {
  border-right: 1px solid #d1d1d1;
  border-bottom: 1px solid #e0e0e0;
  font-size: 12px;
}

#order-listing th:last-child,
#order-listing td:last-child {
  border-right: none;
}

#order-listing tr,
#order-listing td,
#order-listing th {
  height: 20px !important;
  padding: 4px 8px !important;
}

/* Main panel and content wrapper base */
.main-panel,
.content-wrapper {
  padding: 0 !important;
  margin: 0 !important;
  width: 100% !important;
  min-width: 0 !important;
  max-width: 100vw !important;
  min-height: 0 !important;
  box-sizing: border-box !important;
}

/* White Container - behind the table */
.content-wrapper {
  display: flex;
  flex-direction: column;
  min-height: 100vh; 
  padding-top: 0 !important;
  padding-bottom: 0 !important;
  margin-top: 0 !important;
  margin-bottom: 0 !important;
  padding-left: 2px !important;
  transition: opacity 0.3s ease;
  flex: 1;
  overflow-y: visible !important;
  overflow-x: visible !important;
  transition: opacity 0.3s ease;
  padding-bottom: 20px !important; /* Reduce space above footer */
}

@media (max-width: 600px) {
  .content-wrapper {
    padding-left: 8px !important;
  }
}

/* Title spacing */
.card-body > h5.text-left.mt-0.mb-4 {
  margin-bottom: 10px !important;    
  margin-top: 10px !important;
  padding-bottom: 0 !important;
  margin-left: 5px !important;
}

.content-wrapper > h5.text-left.mt-0.mb-4 {
  margin-top: -50px !important;
  margin-bottom: -5px !important;
  margin-left: -15px !important;
}

#order-listing thead th {
  height: 38px !important; /* Increase as needed */
  background: #028084 !important; /* existing bg */
  color: #e5fcff !important;      /* existing color */
  vertical-align: middle !important;
  font-size: 13px !important; /* Adjust font size */
}

.tray-scan-modal,
.new-popup-modal {
  position: fixed;
  top: 0;
  width: 400px;
  height: 100%;
  background: white;
  box-shadow: -3px 0 10px rgba(0, 0, 0, 0.2);
  overflow-y: auto;
  transition: right 0.3s ease, width 0.3s ease, padding 0.3s ease;
  padding: 20px;
  font-family: Arial, sans-serif;
}

.tray-scan-modal {
  right: -500px; /* must match the new width above to stay hidden properly */
  z-index: 9999;
}

.tray-scan-modal.open {
  right: 400px; /* When open, sits next to New Popup */
  width: 600px; /* your desired expanded width */
  margin-right: 20px;
}

.new-popup-modal {
  right: -440px; /* hidden by default */
  z-index: 10000;
}

.new-popup-modal.open {
  right: 0; /* When open, slides in from the right */
}

.tray-scan-close {
  position: absolute;
  right: 10px;
  font-size: 24px;
  font-weight: bold;
  cursor: pointer;
}

#trayScanDetails.table-grid {
  display: grid !important; /* override any existing grid or flex */
  grid-template-columns: repeat(3, 1fr) !important;
  gap: 0px !important;
  max-height: 300px !important;
  overflow-y: auto !important;
  padding-right: 10px; /* prevent scrollbar overlay */
  margin-top: 10px;
}

/* Sticky header row: first 3 divs inside trayScanDetails */
#trayScanDetails.table-grid > div:nth-child(-n + 3) {
  background-color: #e0e0e0;
  font-weight: 600;
  position: sticky;
  top: 0;
  z-index: 2;
  align-items: center;
}

#trayScanModal {
  border-radius: 12px;
  max-height: 90vh;
  top: 40px; /* Moves the entire modal down from the top of the viewport */
  height: calc(100% - 40px); /* Keeps height correct */
}

#trayScanDetails {
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.ms-2{
  margin-top: 8px;
}

/* Make each 
 <p> act like a table cell */
#trayScanDetails p {
  margin: 0;
  padding: 4px 8px;
  background: #f7f7f7;
  border-radius: 6px;
  font-size: 14px;
}

/* Responsive adjustments for screens below 768px */
@media (max-width: 767px) {
  .tray-scan-modal,
  .new-popup-modal {
    width: 100%;
    padding: 10px;
  }
  
  .tray-scan-modal.open {
    width: 100% !important; /* your desired expanded width */
    margin-right: 0px !important;
    right: 0;
    top: 0;
  }
  
  /* On very small screens, stacking is more appropriate */
  .new-popup-modal.open {
    right: 0;
    top: 0;
    /* Optionally, you can add margin-top to separate them */
    margin-top: 20px;
  }

  /* Day Planning Modal Responsive */
  .tray-scan-modal-DayPlanning {
    width: 95%;
    right: 2.5%;
    top: 60px;
    max-height: 70vh;
    padding: 20px;
  }
  
  .modal-top-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  
  #trayScanModal_DayPlanning table th,
  #trayScanModal_DayPlanning table td {
    padding: 4px 6px;
    font-size: 12px;
  }
}

/* Responsive adjustments for tablets (768px to 1024px) */
@media (min-width: 768px) and (max-width: 1024px) {
  .tray-scan-modal,
  .new-popup-modal {
    width: 300px;
    padding: 15px;
  }
  
  .tray-scan-modal {
    right: -300px;
  }
  
  .tray-scan-modal.open {
    right: 300px;
  }
  
  .new-popup-modal {
    right: -300px;
  }
  
  .new-popup-modal.open {
    right: 0;
  }

  .tray-scan-modal-DayPlanning {
    width: 90%;
    right: 5%;
    max-height: 75vh;
  }
  
  .table-responsive {
    max-height: 800px;
  }
}

@media (min-width: 1025px) {
  .table-responsive {
    max-height: 100%;
  }
}

@media (max-width: 1200px) {
  .tray-scan-modal-DayPlanning {
    width: 90%;
    right: 5%;
    max-height: 75vh;
  }
}

.table-responsive {
  max-height: 100%;
  overflow-y: auto;
  scrollbar-width: none;
  -ms-overflow-style: none;
  flex: 1;
}

.table-responsive::-webkit-scrollbar {
  display: none;
}

body {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

.card-body {
  width: 100%;
  overflow-x: auto;
  max-height: 400px;
}

footer {
  position: absolute;
  bottom: 0;
  width: 100%;
  height: 40px;
}

.btn-twitter.btn-social-icon-text i {
  margin-right: 0.5rem !important;
  padding: 0.3rem !important;
  background: #2e7d32;
}

.btn-youtube.btn-social-icon-text i {
  margin-right: 0.5rem !important;
  padding: 0.3rem !important;
}

/* Modal styles */
.image-slider-modal {
  display: none;
  position: fixed;
  top: 40px; /* Leaves room at the top */
  right: 20px;
  width: 600px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  padding: 20px;
  z-index: 10000;
  transition: right 0.3s ease;
}

.image-slider-modal.open {
  display: block;
}

.modal-close-BQ {
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 24px;
  cursor: pointer;
  color: #666;
}

.modal-close-BQ:hover {
  color: #333;
}

/* Slider styles */
.slider {
  position: relative;
  overflow: hidden;
  height: 350px;
}

.slides {
  display: flex;
  transition: transform 0.5s ease;
}

.slide {
  flex: 0 0 100%;
  box-sizing: border-box;
  display: none;
}

.slide.active {
  display: block;
}

.slide img {
  width: 100%;
  height: 350px;
  object-fit: cover;
  display: block;
}

.prev,
.next {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0,0,0,0.5);
  border: none;
  color: #fff;
  padding: 8px;
  cursor: pointer;
  border-radius: 50%;
  user-select: none;
}

.prev { left: 10px; }
.next { right: 10px; }

@media (max-width: 767px) {
  .image-slider-modal {
    width: 100%;
    right: 0;
    top: 0;
    border-radius: 0;
    padding: 10px;
  }
  .slider { height: 250px; }
  .slide img { height: 250px; }
}

</style>

<div class="content-wrapper">
  <!--<h5 class="text-left mt-0 mb-3">Input Screening / Pick Table</h5>-->
  <div class="row">
    <div class="col-12 grid-margin stretch-card">
      <div class="card">
        <div class="card-body" style="padding-bottom:12px;">
          <h5 class="text-left mt-0 mb-4" style="font-weight:700;">Input Screening Pick Table</h5>
          <div class="table-responsive">
            <div class="table-responsive">
              <table id="order-listing" class="table">
                <thead>
                    <tr>
                      <th>
                      S.No <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Last<br>Updated
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Plating Stk No
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Polishing Stk No
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Plating Color
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                     <th>
                      Category
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Polish Finish
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Tray Cate-Capacity
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Input Source
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    
                    <th>
                      No of Trays <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      LOT Qty
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Physical Qty
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      IPA Wiping <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Accept Qty
                      <i class="fa fa-filter" aria-hidden="true"></i>
                      </th>
                    <th>
                      Reject Qty
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Process Status
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Action <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Lot Status
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Current Stage
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Remarks <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                   
                  </tr>
                </thead>
                <tbody>
                  <!-- Row 1 - Highlighted -->
                   {% for data in master_data %}
                <tr class="highlighted-tray-scan{% if data.hold_lot %} row-inactive{% endif %}"
                    data-stock-lot-id="{{ data.stock_lot_id }}"
                    data-batch-id="{{ data.batch_id }}"
                    data-available-qty="{{ data.available_qty }}"
                    data-ip-onhold-picking="{{ data.ip_onhold_picking }}"
                      data-model-no="{{ data.model_stock_no__model_no }}">
                    
                  <td {% if data.ip_hold_lot %} class="row-inactive-blur"{% endif %}>
                      <span style="display:flex; align-items:center; gap:6px;">
                        <label class="hold-toggle-switch" style="margin-bottom:0;">
                          {% if not data.ip_hold_lot %}
                            <input type="checkbox" class="hold-toggle-btn" checked />
                            <span class="hold-slider"></span>
                          {% else %}
                            <input type="checkbox" class="hold-toggle-btn" />
                            <span class="hold-slider"></span>
                          {% endif %}
                        </label>
                        <!-- Hold remark icon -->
                        <span class="hold-remark-icon" 
                            style="display:{% if data.ip_hold_lot or data.ip_release_lot %}inline-block{% else %}none{% endif %}; cursor:pointer;" 
                            title="{% if data.ip_holding_reason %}Holding Reason: {{ data.ip_holding_reason }}{% endif %}{% if data.ip_holding_reason and data.ip_release_reason %}&#10;{% endif %}{% if data.ip_release_reason %}Release Reason: {{ data.ip_release_reason }}{% endif %}">
                        {% if data.ip_hold_lot or data.ip_release_lot %}
                          <img src="{% static 'assets/icons/view2.png' %}" alt="Remark" style="width:18px; height:18px;" />
                        {% endif %}
                      </span>
                        <span class="sno-value">{{ forloop.counter }}</span>
                      </span>
                    </td>               
                    <td {% if data.ip_hold_lot %} class="row-inactive-blur" {% endif %}>
                              {{ data.last_process_date_time|date:"Y-m-d" }}<br>
                        <span style="display:inline-block; margin-top:4px;">{{ data.last_process_date_time|date:"h:i A" }}</span>
                        <td {% if data.ip_hold_lot %} class="row-inactive-blur" {% endif %} >
                      <span class="model-hover-trigger" style="cursor: pointer;">
                        {{ data.plating_stk_no }}
                        <div class="model-image-tooltip" style="position: absolute; left: 50%; top: 110%; transform: translateX(-50%); background: #fff; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 12px 18px; z-index: 9999; display: flex; align-items: center; gap: 8px; opacity: 0; pointer-events: none; transition: opacity 0.2s;">
                          <button class="img-scroll-left" style="background: none; border: none; font-size: 20px; cursor: pointer;">&#8592;</button>
                          <div class="img-gallery" style="display: flex; gap: 6px; overflow: hidden; width: 180px;">
                            {% for img_url in data.model_images %}
                              <img src="{{ img_url }}" style="width: 55px; height: 55px; object-fit: cover; border-radius: 6px;" />
                            {% endfor %}
                          </div>
                          <button class="img-scroll-right" style="background: none; border: none; font-size: 20px; cursor: pointer;">&#8594;</button>
                        </div>
                      </span>
                    </td>
                    <td {% if data.ip_hold_lot %} class="row-inactive-blur" {% endif %}>{{ data.polishing_stk_no }}</td>
                    <td {% if data.ip_hold_lot %} class="row-inactive-blur" {% endif %}>{{ data.plating_color }}</td>
                    <td {% if data.ip_hold_lot %} class="row-inactive-blur" {% endif %}>{{ data.category }}</td>
                    <td {% if data.ip_hold_lot %} class="row-inactive-blur" {% endif %}>{{data.polish_finish}}</td>
                    <td {% if data.ip_hold_lot %} class="row-inactive-blur" {% endif %}>{{data.tray_type}} {{data.tray_capacity}}</td>
                    <td {% if data.ip_hold_lot %} class="row-inactive-blur" {% endif %}>{{data.vendor_internal}}</td>
                    <td {% if data.ip_hold_lot %} class="row-inactive-blur" {% endif %}>{{data.no_of_trays}}</td>
                    <td {% if data.ip_hold_lot %} class="row-inactive-blur" {% endif %}>
                      <span class="lot-qty" style="min-width: 30px; text-align: right">{{ data.total_batch_quantity }}</span>
                      <span style="display: inline-flex; align-items: center; gap: 4px;">
                        <input type="checkbox"
                                class="ip-checkbox"
                                data-lot-id="{{ data.stock_lot_id }}"
                                style="width: 15px; height: 15px"
                                {% if data.ip_person_qty_verified %}checked disabled{% endif %} />
                        <input type="text"
                                class="missing-qty-input"
                                value="{{ data.dp_missing_qty|default_if_none:'' }}"
                                style="width: 36px; padding: 1px 3px; font-size: 13px; border: 1px solid #ccc; border-radius: 4px;"
                                {% if data.ip_person_qty_verified %}disabled{% endif %} />
                      </span>
                    </td>
                    <td {% if data.ip_hold_lot %} class="row-inactive-blur" {% endif %}>
                      <input
                        type="text"
                        class="physical-qty-input"
                        value="{{ data.dp_physical_qty }}"
                        style="width: 36px; padding: 1px 3px; font-size: 13px; border: 1px solid #ccc; border-radius: 4px;
                              {% if data.dp_physical_qty_edited %}background-color: #fff3cd; border-color: #ffc107;{% endif %}"
                        readonly
                        {% if data.dp_physical_qty_edited %}title="This quantity was edited"{% endif %}
                      />
                    </td>

                    <!-- Wiping Req (STATIC) -->
                    <td {% if data.ip_hold_lot %} class="row-inactive-blur" {% endif %}>
                      {% if data.wiping_required %}
                        <div class="d-inline-block px-3 fw-semibold text-center rounded-pill" style="border: 2px solid #0d5d17; background-color: #c5f9c2; color: #2f801b;">
                          Yes
                        </div>
                      {% else %}
                        <div class="d-inline-block px-3 fw-semibold text-center rounded-pill" style="border: 2px solid #5d0d0d; background-color: #f9c2c2; color: #801b1b;">
                          No
                        </div>
                      {% endif %}
                    </td>
                    <td {% if data.ip_hold_lot %} class="row-inactive-blur" {% endif %}>
                        {{ data.display_accepted_qty|default:0 }}    
                    </td>
                    <td {% if data.ip_hold_lot %} class="row-inactive-blur" {% endif %}>
                        {{ data.ip_rejection_total_qty|default:0 }}
                    </td>
                    <!-- Process Status Column -->
                    <td {% if data.ip_hold_lot %} class="row-inactive-blur" {% endif %}>
                      <div class="process-status-group d-flex align-items-center justify-content-center" style="gap: 6px;">
                        <!-- Q icon -->
                        <div
                          title="Tray Scan"
                          class="d-flex align-items-center justify-content-center rounded-circle"
                          style="width: 28px; height: 28px; background-color: {% if data.ip_person_qty_verified %}#0c8249{% else %}#bdbdbd{% endif %}; color: white; font-weight: bold; font-size: 15px;">
                          Q
                        </div>
                        <!-- W icon/radio -->
                        {% if data.wiping_required %}
                          <label style="display: flex; align-items: center; gap: 2px; margin: 0;">
                            <input type="radio" class="process-status-w" name="process_status_w_{{ forloop.counter }}">
                            <span class="w-label" style="margin-left:2px;">W</span>
                          </label>
                        {% else %}
                          <span class="w-label" style="margin-left:2px; opacity:0.5; cursor:not-allowed; font-weight: bold;">W</span>
                        {% endif %}
                        <!-- S icon -->
                        <div
                          title="Status"
                          class="d-flex align-items-center justify-content-center rounded-circle"
                          style="width: 28px; height: 28px; background-color: {% if data.rejected_ip_stock or data.accepted_Ip_stock or data.few_cases_accepted_Ip_stock %}#0c8249{% else %}#bdbdbd{% endif %}; color: white; font-weight: bold; font-size: 15px;">
                          S
                        </div>
                      </div>
                    </td>
                    <td {% if data.ip_hold_lot %} class="row-inactive-blur" {% endif %}>
                      
                      {% if not data.accepted_Ip_stock and not data.rejected_ip_stock and not data.accepted_tray_scan_status %}
                        {% if data.ip_person_qty_verified %}
                          <a href="#" class="edit-qty-btn" data-batch-id="{{ data.batch_id }}">
                            <img src="{% static 'assets/icons/edit1.png' %}" alt="Edit" style="width: 28px; margin-right: 8px; height: auto"/>
                          </a>
                          <a href="#" class="delete-batch-btn" title="Delete" data-batch-id="{{ data.batch_id }}" data-stock-lot-id="{{ data.stock_lot_id }}">
                            <img src="{% static 'assets/icons/bin.png' %}" alt="Delete" style="width: 20px; margin-right: 8px; height: auto" />
                          </a>
                        {% else %}
                          <span title="Edit Disabled" style="opacity: 0.5; pointer-events: none;">
                            <img src="{% static 'assets/icons/edit1.png' %}" alt="Edit Disabled" style="width: 20px; margin-right: 8px; height: auto; filter: grayscale(1) opacity(0.5);" />
                          </span>
                          <span title="Delete Disabled" style="opacity: 0.5; pointer-events: none;">
                            <img src="{% static 'assets/icons/bin.png' %}" alt="Delete Disabled" style="width: 20px; margin-right: 8px; height: auto; filter: grayscale(1) opacity(0.5);" />
                          </span>
                        {% endif %}
                      {% else %}
                        <span title="Edit Disabled" style="opacity: 0.5; pointer-events: none;">
                          <img src="{% static 'assets/icons/edit1.png' %}" alt="Edit Disabled" style="width: 20px; margin-right: 8px; height: auto; filter: grayscale(1) opacity(0.5);" />
                        </span>
                        <span title="Delete Disabled" style="opacity: 0.5; pointer-events: none;">
                          <img src="{% static 'assets/icons/bin.png' %}" alt="Delete Disabled" style="width: 20px; margin-right: 8px; height: auto; filter: grayscale(1) opacity(0.5);" />
                        </span>
                      {% endif %}
                      {% if not data.accepted_Ip_stock and not data.rejected_ip_stock and not data.accepted_tray_scan_status %}
                        <!-- IQF Acceptance - Show buttons as ACTIVE/CLICKABLE -->
                        <button type="button" class="btn btn-social-icon-text btn-twitter"
                                style="background-color: #66bb6a;"
                                data-lot-id="{{ data.stock_lot_id }}"
                          {% if not data.ip_person_qty_verified %}disabled{% endif %}>
                          <i class="fa fa-check-circle"></i>Accept
                        </button>
                        <button type="button" class="btn btn-social-icon-text btn-youtube tray-scan-btn"
                                style="background-color: #e57373;"
                                data-stock-lot-id="{{ data.stock_lot_id }}"
                                data-batch-id="{{ data.batch_id }}"
                        {% if not data.ip_person_qty_verified %}disabled{% endif %}>

                          <i class="fa fa-times-circle"></i>Reject
                        </button>

                      {% elif data.accepted_Ip_stock %}
                        <!-- Input screening Acceptance (disabled) -->
                        <span class="btn btn-social-icon-text btn-twitter"
                              style="background-color: #66bb6a; pointer-events: none; opacity: 0.8; cursor: not-allowed;">
                          <i class="fa fa-check-circle"></i>Accepted
                        </span>
                        <button type="button" class="btn btn-social-icon-text btn-youtube tray-scan-btn"
                                style="background-color: #e57373; opacity: 0.6; cursor: not-allowed; pointer-events: none;"
                                data-stock-lot-id="{{ data.stock_lot_id }}"
                                data-batch-id="{{ data.batch_id }}"
                                disabled
                        {% if not data.ip_person_qty_verified %}disabled{% endif %}>

                          <i class="fa fa-times-circle"></i>Reject
                        </button>

                      {% elif data.ip_onhold_picking %}
                        <!-- Brass On-Hold Picking -->
                        <button type="button" class="btn btn-social-icon-text btn-twitter"
                                style="background-color: #66bb6a; opacity: 0.6; cursor: not-allowed; pointer-events: none;"
                                data-lot-id="{{ data.stock_lot_id }}"
                                disabled>
                          <i class="fa fa-check-circle"></i>Accept
                        </button>
                        <button type="button" class="btn btn-social-icon-text btn-youtube tray-scan-btn"
                                style="background-color: #e57373;"
                                data-stock-lot-id="{{ data.stock_lot_id }}"
                                data-batch-id="{{ data.batch_id }}">
                          <i class="fa fa-times-circle"></i> Partial Reject
                        </button>

                      {% elif data.rejected_ip_stock or data.few_cases_accepted_Ip_stock %}
                        <!-- Input screening Rejection or Few Cases Acceptance (disabled) -->
                        <button type="button" class="btn btn-social-icon-text btn-twitter"
                                style="background-color: #66bb6a; pointer-events: none; opacity: 0.6; cursor: not-allowed;"
                                disabled>
                          <i class="fa fa-check-circle"></i>Accept
                        </button>
                        <span class="btn btn-social-icon-text btn-youtube"
                              style="background-color: #e57373; pointer-events: none; opacity: 0.8; cursor: not-allowed;">
                          <i class="fa fa-times-circle"></i>Rejected
                        </span>

                      {% else %}
                        <!-- Default state - Both buttons enabled -->
                        <button type="button" class="btn btn-social-icon-text btn-twitter"
                                style="background-color: #66bb6a"
                                data-lot-id="{{ data.stock_lot_id }}"
                                {% if not data.ip_person_qty_verified %}disabled{% endif %}>
                          <i class="fa fa-check-circle"></i>Accept
                        </button>
                        <button type="button" class="btn btn-social-icon-text btn-youtube tray-scan-btn"
                                style="background-color: #e57373;"
                                data-stock-lot-id="{{ data.stock_lot_id }}"
                                data-batch-id="{{ data.batch_id }}"
                                {% if not data.ip_person_qty_verified %}disabled{% endif %}>
                          <i class="fa fa-times-circle"></i>Reject
                        </button>
                      {% endif %}
                      <!-- Eye icon to view submitted "Tray Scan Table" -->
                          <a href="#"
                          title="View"
                          class="text-primary tray-scan-btn-DayPlanning-view tray-scan-btn-Jig"
                          style="text-decoration: underline"
                          data-stock-lot-id="{{ data.stock_lot_id }}"
                          data-batch-id="{{ data.batch_id }}"
                          data-model-no="{{ data.model_stock_no__model_no }}"
                          data-no-of-trays="{{ data.no_of_trays }}"
                          data-tray-capacity="{{ data.tray_capacity|default:'0' }}"
                          data-moved-to-d-picker="{{ data.Moved_to_D_Picker }}"
                          data-tray-qty-list="{{ data.tray_qty_list|default:'[]'|safe }}"
                          data-model-image="{{ data.model_images.0|default:'' }}">
                          <img src="{% static 'assets/icons/view.png' %}"
                              alt="View"
                              style="width: 20px; margin-right: 8px; height: auto; cursor:pointer;" />
                        </a>
                    </td>
                    <td {% if data.ip_hold_lot %} class="row-inactive-blur" {% endif %}>
                      {% if data.ip_onhold_picking  %}
                        <div
                          class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                          style="
                            border: 2px solid #4997ac;
                            background-color: #d1f2f3;
                            color: #03425d;
                            font-size: clamp(0.75rem, 2vw, 0.875rem);
                            white-space: nowrap;
                            padding-top: 0.5rem;
                            padding-bottom: 0.5rem;
                          "
                        >
                          On-Hold
                        </div>
                      {% elif data.rejected_ip_stock or data.few_cases_accepted_Ip_stock or data.accepted_Ip_stock %}
                        <div class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                            style="border: 2px solid #0d5d17; background-color: #c5f9c2; color: #2f801b; font-size: clamp(0.3rem, 2vw, 0.875rem); white-space: nowrap; padding: 0.3rem;">
                          Yet to Release
                        </div>
                      {% else %}
                        <div class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                            style="border: 2px solid #f9a825; background-color: #fff8e1; color: #b26a00; font-size: clamp(0.3rem, 2vw, 0.875rem); white-space: nowrap; padding: 0.3rem;">
                          Yet to Start
                        </div>
                      {% endif %}
                    </td>
                    <td {% if data.ip_hold_lot %} class="row-inactive-blur" {% endif %}>
                      <div
                        class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                        style="
                          border: 2px solid
                            {% if data.last_process_module == 'Input screening' %}
                              #0d5d17
                            {% elif data.last_process_module == 'Input screening' %}
                              #f9a825
                            {% elif data.last_process_module == 'DayPlanning' %}
                              #1976d2
                            {% else %}
                              #9adeed
                            {% endif %};
                          background-color:
                            {% if data.last_process_module == 'Input screening' %}
                              #c5f9c2
                            {% elif data.last_process_module == 'Input screening' %}
                              #fff8e1
                            {% elif data.last_process_module == 'DayPlanning' %}
                              #d1eaff
                            {% else %}
                              #d1edf3
                            {% endif %};
                          color:
                            {% if data.last_process_module == 'Input screening' %}
                              #2f801b
                            {% elif data.last_process_module == 'Input screening' %}
                              #b26a00
                            {% elif data.last_process_module == 'DayPlanning' %}
                              #033b5d
                            {% else %}
                              #033b5d
                            {% endif %};
                          font-size: clamp(0.75rem, 2vw, 0.875rem);
                          white-space: nowrap;
                          padding-top: 0.5rem;
                          padding-bottom: 0.5rem;
                        "
                      >
                        {{ data.last_process_module|default:"N/A" }}
                      </div>
                    </td>
                    <td {% if data.ip_hold_lot %} class="row-inactive-blur" {% endif %}>
                      {% if not data.accepted_Ip_stock and not data.rejected_ip_stock and not data.accepted_tray_scan_status and not data.few_cases_accepted_Ip_stock %}
                          {% if data.ip_person_qty_verified %}

                            <!-- VoiceRec with tooltip (audio remark) -->
                              <a href="#" title="Add Audio Remark" class="remark-tooltip-trigger" style="display: inline-flex; align-items: center; height: 28px; margin-left: 0; position: relative; cursor: pointer;">
                                <img src="{% static 'assets/icons/rec.png' %}" alt="VoiceRec" style="width: 20px; height: 20px"/>
                                <div class="remark-tooltip" style="position: absolute; top: 110%; left: 50%; transform: translateX(-50%); width: 300px; background: #fff; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; padding: 15px; z-index: 1000;">
                                  <div style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 10px solid #fff;"></div>
                                  <!-- Audio recording UI placeholder -->
                                  <div style="display: flex; align-items: center; gap: 10px;">
                                    <button type="button" style="background: #28a745; color: #fff; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; display: flex; align-items: center; justify-content: center;">
                                      <i class="fa fa-microphone"></i>
                                    </button>
                                    <span style="font-size: 14px; color: #333;">Hold to record audio</span>
                                  </div>
                                  <div style="text-align: right; margin-top: 10px;">
                                    <button type="button" style="background-color: #007bff; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                                      <i class="fa fa-send"></i>
                                    </button>
                                  </div>
                                </div>
                              </a>

                                <a
                              href="#"
                              title="Add Remark"
                              class="remark-tooltip-trigger"
                              style="display: inline-flex; align-items: center; height: 20px; margin-left: 5px; position: relative; cursor: pointer;"
                            >
                              <img
                                src="{% static 'assets/icons/chat1.png' %}"
                                alt="Chat"
                                style="width: 20px; height: 20px"
                              />
                              <div
                                class="remark-tooltip"
                                style="position: absolute; top: 110%; left: 50%; transform: translateX(-50%); width: 300px; background: #fff; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; padding: 15px; z-index: 1000;"
                              >
                                <div
                                  style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 10px solid #fff;"
                                ></div>
                                <textarea
                                  placeholder="Type your remark..."
                                  style="width: 85%; height: 40px; resize: vertical; border: 1px solid #ccc; padding: 5px; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px;"
                                  {% if data.IP_pick_remarks %}readonly{% endif %}
                                >{{ data.IP_pick_remarks|default_if_none:"" }}</textarea>
                                <div style="text-align: right; margin-top: -35px">
                                  {% if not data.IP_pick_remarks %}
                                  <button
                                    type="button"
                                    style="background-color: #007bff; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px;"
                                  >
                                    <i class="fa fa-send"></i>
                                  </button>
                                  {% else %}
                                  <div style="margin-top: 40px; color: #31708f; background: #d9edf7; border: 1px solid #bce8f1; border-radius: 4px; padding: 8px 12px; font-size: 10px; text-align: left;">
                                    <i class="fa fa-info-circle" style="margin-right: 6px;"></i>
                                    Remark already saved and cannot be edited.
                                  </div>
                                  {% endif %}
                                </div>
                              </div>
                              </a>
                         {% else %}

                                <!-- Audio Remark Icon (disabled) -->
                            <span title="Disabled after moved" style="display: inline-flex; align-items: center; height: 28px; margin-left: 0; opacity: 0.5; pointer-events: none;">
                              <img src="{% static 'assets/icons/rec.png' %}" alt="VoiceRec Disabled" style="width: 20px; height: 20px; filter: grayscale(1) opacity(0.5);" />
                            </span>
                            <!-- Chat Remark Icon (disabled) -->
                            <span title="Disabled after moved" style="display: inline-flex; align-items: center; height: 20px; margin-left: 5px; opacity: 0.5; pointer-events: none;">
                              <img src="{% static 'assets/icons/chat1.png' %}" alt="Chat Disabled" style="width: 20px; height: 20px; filter: grayscale(1) opacity(0.5);" />
                            </span>
                            {% endif %}

                      {% else %}
                      <!-- Audio Remark Icon (disabled) -->
                      <span title="Disabled after moved" style="display: inline-flex; align-items: center; height: 28px; margin-left: 0; opacity: 0.5; pointer-events: none;">
                        <img src="{% static 'assets/icons/rec.png' %}" alt="VoiceRec Disabled" style="width: 20px; height: 20px; filter: grayscale(1) opacity(0.5);" />
                      </span>
                      <!-- Chat Remark Icon (disabled) -->
                      <span title="Disabled after moved" style="display: inline-flex; align-items: center; height: 20px; margin-left: 5px; opacity: 0.5; pointer-events: none;">
                        <img src="{% static 'assets/icons/chat1.png' %}" alt="Chat Disabled" style="width: 20px; height: 20px; filter: grayscale(1) opacity(0.5);" />
                      </span>
                    {% endif %}
                    </td>
                   
                  </tr>
                  {% endfor%}
              
                </tbody>
              </table>

              <!-- Tray Scan Modal for Input Screening -->
              <div
                id="trayScanModal_DayPlanning"
                class="tray-scan-modal-DayPlanning"
              >
                <div class="tray-scan-modal-DayPlanning-content">
                  <span id="closeTrayScanModal_DayPlanning" class="tray-scan-close-readonly"
                    >&times;</span
                  >
                  <!-- New top header container: title + user profile aligned left -->
                  <div
                    class="modal-top-header"
                    style="
                      display: flex;
                      align-items: center;
                      gap: 20px;
                      padding-bottom: 10px;
                    "
                  >
                    <div
                      class="user-profile"
                      style="display: flex; align-items: center; gap: 8px"
                    >
                      <img
                        src="/static/assets/images/imagePlaceholder.png"
                        alt="User Profile"
                        style="
                          border-radius: 50%;
                          width: 50px;
                          height: 50px;
                          object-fit: cover;
                        "
                      />
                      <span>Model No:</span>
                      <h6 id="modalModelNo_DayPlanning">(Fetch Dynamically)</h6>
                    </div>
                  </div>
                  <!-- Redo icon for clearing "tray ID" -->
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <h5 style="text-align: center; margin: 0; flex: 1; font-weight: 600; color:#595959">
                      Input Screening - Tray Scan (Day Planning API)
                    </h5>
                    <button id="trayValidateBtn" type="button" style="display: flex; align-items: center; gap: 6px; background: #f5faff; border: 1px solid #023E4DCC; color: #023E4DCC; border-radius: 20px; padding: 4px 14px; font-size: 12px; font-weight: 500; cursor: pointer;">
                        <img src="{% static 'assets/icons/barcode.png' %}" alt="Validate" style="width: 20px; height: 20px; margin-right: 4px;" />
                        Tray Validate
                    </button>

                    <!-- Hidden input field - completely invisible to users -->
                    <input id="trayValidateInput" type="text" placeholder="Enter validation info..." style="position: absolute; left: -9999px; opacity: 0; pointer-events: none;" />

                    <img
                        src="{% static 'assets/icons/redo2.png' %}"
                        alt="Redo"
                        id="trayScanRedoBtn"
                        style="width: 24px; height: 24px; cursor: pointer; margin-left: 8px;"
                        title="Clear Tray IDs"
                    />
                  </div>
                  
                  <!-- Error message container - initially hidden -->
                  <div id="trayErrorMessage" style="display: none; background-color: #ffebee; border: 1px solid #f44336; color: #c62828; padding: 8px 12px; border-radius: 4px; margin-bottom: 10px; font-size: 12px; text-align: center;">
                    <span id="trayErrorText"></span>
                  </div>
                  
                  <!-- trayScanDetails_DayPlanning will be a scrollable 3-column grid with headers and unlimited rows -->
                  <div id="trayScanDetails_DayPlanning" class="table-grid">
                    <!-- Headers -->
                    <div>S.no</div>
                    <div>Tray ID</div>
                    <div>Tray Quantity</div>
                    <div class="tray-validation-status-header">Tray Validation Status
                      <span style="margin-left: 10px;">
              <img src="{% static 'assets/icons/fail.png' %}" alt="Cross" title="Fail" style="width:18px; height:18px; margin-right:6px; vertical-align:middle;" />
              <img src="{% static 'assets/icons/pass.png' %}" alt="Pass" title="Pass" style="width:18px; height:18px; vertical-align:middle;" />
              </span>
                    </div>
                    <!-- Example rows (replace with dynamic content) -->
                  </div>
                  <!-- No buttons for read-only modal -->
                </div>
              </div>
               </div>
              <!-- Tray Scan Details Modal (Left Popup) -->
              <div id="trayScanModal" class="tray-scan-modal">
                <div class="tray-scan-modal-content">
                  <span id="closeTrayScanModal" class="tray-scan-close"
                    >&times;</span
                  >
                  <h3 id="trayScanModalHeader">Input Screening / <span class="modal-model-no">(Fetch Dynamically)</span> / Rejection Window</h3>                  <div id="trayScanDetails">
                    <!-- Dynamic content will be loaded here -->
                  </div>
                </div>
              </div>
              <!-- New Popup Modal (Right Popup) -->
              <div id="newPopupModal" class="new-popup-modal">
                <div class="tray-scan-modal-content">
                  <span id="closeNewPopupModal" class="tray-scan-close"
                    >&times;</span
                  >
                  <!-- New top header container: title + user profile aligned left -->
                  <div
                    class="modal-top-header"
                    style="
                      display: flex;
                      align-items: center;
                      gap: 20px;
                      padding-bottom: 10px;
                    "
                  >
                    <div
                      class="user-profile"
                      style="display: flex; align-items: center; gap: 8px"
                    >
                      <img
                        src="{% static 'assets/images/imagePlaceholder.png' %}"
                        alt="User Profile"
                        style="
                          border-radius: 50%;
                          width: 50px;
                          height: 50px;
                          object-fit: cover;
                        "
                      />
                      <span>Model No:</span>
                      <h6>(Fetch Dynamically) / Accepted Tray Rescan</h6>
                    </div>
                  </div>



                  
                  <!-- Existing centered h3 title -->
                  <!-- Redo icon for clearing "tray ID" -->
                 <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
                    <h5 style="text-align: center; margin: 0; flex: 1; font-weight: 600; color:#595959">
                      Accepted - Top Tray Scan
                    </h5>
                    <img
                      src="{% static 'assets/icons/redo2.png' %}"
                      alt="Redo"
                      
                      id="trayScanRedoBtn"
                      style="width: 24px; height: 24px; cursor: pointer; margin-right: 14px;"
                      title="Clear Tray IDs"
                    />
                  </div>
                  <!-- Accepted Case Tray Scan Table - Grid View with Visible Borders -->
                  <div id="trayScanDetails" class="table-grid">
                    
                    <!-- NEW BUTTONS SECTION -->
                    <div class="tray-scan-modal-buttons" style="grid-column: 1 / -1; display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
                       <button
                    style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 30px;">
                    Draft
                  </button>
                  <button
                    style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 30px;">
                    Submit
                  </button>
                  <button
                    style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 30px;">
                    Cancel
                  </button>
                    </div>
                  </div>
                </div>
              </div>
              
            </div>
            
           
          </div>

          

        </div>
        
      </div>
      
    </div>

  
  <!-- Image Slider Modal (popup) -->
  <div id="imageSliderModal" class="image-slider-modal">
    <span id="closeImageSliderModal" class="modal-close-BQ">&times;</span>
    <h3>Visual Aid</h3>
    <div class="slider" id="slider">
      <div class="slides" id="slidesContainer">
        <div class="slide active">
          <img src="{% static 'assets/images/carousel/banner_1.jpg' %}" alt="Slide 1">
        </div>
        <div class="slide">
          <img src="{% static 'assets/images/carousel/banner_2.jpg' %}" alt="Slide 2">
        </div>
        <div class="slide">
          <img src="{% static 'assets/images/carousel/banner_3.jpg' %}" alt="Slide 3">
        </div>
      </div>
      <button class="prev" id="prevBtn">&#10094;</button>
      <button class="next" id="nextBtn">&#10095;</button>
    </div>
  </div>
  <!-- Image Slider Modal -->
  <div id="imageSliderModal" class="image-slider-modal">
    <span id="closeImageSliderModal" class="modal-close-BQ">&times;</span>
    <div class="slider" id="slider">
      <button class="prev" id="prevBtn">&#8592;</button>
      <div class="slides"></div>
      <button class="next" id="nextBtn">&#8594;</button>
    </div>
  </div>
<!-- Hold Remark Modal -->
<div id="holdRemarkModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.18); z-index:20000; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:10px; padding:28px 32px 18px 32px; min-width:320px; max-width:90vw; box-shadow:0 4px 24px rgba(0,0,0,0.18); position:relative;">
    <span id="closeHoldRemarkModal" style="position:absolute; top:8px; right:16px; font-size:22px; font-weight:bold; color:#d9534f; cursor:pointer;">&times;</span>
    <h5 style="margin-bottom:16px; color:#028084;">Row Hold Remark</h5>
    <textarea id="holdRemarkInput" maxlength="50" style="width:100%; height:60px; border:1px solid #ccc; border-radius:6px; padding:8px; font-size:15px; resize:none;" placeholder="Enter remark (max 50 chars)"></textarea>
    <div style="text-align:right; margin-top:10px;">
      <button id="saveHoldRemarkBtn" style="background:#007bff; color:#fff; border:none; border-radius:20px; padding:6px 18px; font-size:15px; cursor:pointer;">Save</button>
    </div>
    <div id="holdRemarkError" style="color:red; font-size:13px; min-height:18px; margin-top:6px;"></div>
  </div>
</div>

<!-- Pagination Section -->
<div class="pagination-wrapper">
  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-end mb-0">
      {# Previous button #}
      {% if page_obj.has_previous %}
        <li>
          <a href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
            <span aria-hidden="true"><i class="fa fa-chevron-left"></i></span>
          </a>
        </li>
      {% else %}
        <li class="disabled">
          <span aria-hidden="true"><i class="fa fa-chevron-left"></i></span>
        </li>
      {% endif %}
      {# Always show first page #}
      {% if page_obj.number > 3 %}
        <li><a href="?page=1">1</a></li>
        {% if page_obj.number > 4 %}
          <li class="disabled"><span>…</span></li>
        {% endif %}
      {% endif %}
      {# Show pages around current page #}
      {% for num in page_obj.paginator.page_range %}
        {% if num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
          {% if num == page_obj.number %}
            <li class="active"><span>{{ num }}</span></li>
          {% else %}
            <li><a href="?page={{ num }}">{{ num }}</a></li>
          {% endif %}
        {% endif %}
      {% endfor %}
      {# Show ellipsis and last page if needed #}
      {% if page_obj.number < page_obj.paginator.num_pages|add:'-2' %}
        {% if page_obj.number < page_obj.paginator.num_pages|add:'-3' %}
          <li class="disabled"><span>…</span></li>
        {% endif %}
        <li><a href="?page={{ page_obj.paginator.num_pages }}">{{ page_obj.paginator.num_pages }}</a></li>
      {% endif %}
      {# Next button #}
      {% if page_obj.has_next %}
        <li>
          <a href="?page={{ page_obj.next_page_number }}" aria-label="Next">
            <span aria-hidden="true"><i class="fa fa-chevron-right"></i></span>
          </a>
        </li>
      {% else %}
        <li class="disabled">
          <span aria-hidden="true"><i class="fa fa-chevron-right"></i></span>
        </li>
      {% endif %}
    </ul>
  </nav>
</div>
            
  {% block script %}

<!-- Script for opening Input Screening - Tray Scan modal with read-only view using Day Planning APIs -->
<script nonce="{{ csp_nonce }}">
// Updated script for opening Input Screening - Tray Scan modal using Day Planning APIs
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll('.tray-scan-btn-DayPlanning-view').forEach(function(link) {
    link.addEventListener('click', async function (e) {
      e.preventDefault();

      // Get modal elements
      const modal = document.getElementById("trayScanModal_DayPlanning");
      const detailsDiv = document.getElementById("trayScanDetails_DayPlanning");
      const modalModelNo = document.getElementById("modalModelNo_DayPlanning");
      modal.dataset.batchId = link.getAttribute('data-batch-id');

      // Get data attributes
      const batchId = link.getAttribute('data-batch-id');
      const stockLotId = link.getAttribute('data-stock-lot-id');
      const modelNo = link.getAttribute('data-model-no');
      const noOfTrays = parseInt(link.getAttribute('data-no-of-trays')) || 0;
      const trayCapacity = link.getAttribute('data-tray-capacity') || "";
      let trayQtyList = [];
      try {
        trayQtyList = JSON.parse(link.getAttribute('data-tray-qty-list') || "[]");
      } catch (e) {
        trayQtyList = [];
      }

      // Set model number in modal
      if (modalModelNo && modelNo) {
        modalModelNo.textContent = modelNo;
      }

      // --- ADD THIS BLOCK HERE ---
      const modalUserImg = modal.querySelector('.user-profile img');
      const modelImage = link.getAttribute('data-model-image');
      if (modalUserImg) {
        if (modelImage) {
          modalUserImg.src = modelImage;
        } else {
          modalUserImg.src = "/static/assets/images/imagePlaceholder.png";
        }
      }

      // ✅ UPDATED: Fetch tray data with proper top tray handling using Day Planning API
      let traysData = [];
      try {
        const resp = await fetch(`/dayplanning/completed_tray_id_list/?batch_id=${encodeURIComponent(batchId)}`);
        const result = await resp.json();
        if (result.success && Array.isArray(result.trays) && result.trays.length > 0) {
          // Data is already ordered with top tray first from the API
          traysData = result.trays;
          console.log('Fetched trays data:', traysData); // Debug log
        }
      } catch (e) {
        console.error('Error fetching tray data:', e);
      }

      // Build modal content as a table - Initially show only 3 columns
      function buildTableHTML(showValidationColumn = false) {
        let html = `
          <table class="table table-bordered table-sm" style="width:100%; margin-bottom:0;">
            <thead>
              <tr>
                <th style="width:50px;">S.no</th>
                <th>Tray ID</th>
                <th>Tray Qty</th>
                ${showValidationColumn ? '<th>Tray Validation Status</th>' : ''}
              </tr>
            </thead>
            <tbody>
        `;
        
        // If we have trays data from API, use it directly
        if (traysData && traysData.length > 0) {
          traysData.forEach((tray, index) => {
            // Display S.no based on whether it's top tray or not
            const displaySNo = tray.is_top_tray ? '1 (Top Tray)' : tray.s_no;
            
            html += `
              <tr>
                <td>${displaySNo}</td>
                <td>
                  <input type="text" class="form-control" value="${tray.tray_id || ''}" readonly style="width: 100%;" />
                </td>
                <td>
                  <input type="number" class="form-control" value="${tray.tray_quantity || ''}" readonly style="width: 100%;" />
                </td>
                ${showValidationColumn ? `
                  <td>
                    <div class="validation-status">
                      <div class="status-icon fail">
                        <img src="{% static 'assets/icons/fail.png' %}" alt="Fail" title="Fail" style="width:18px; height:18px;" />
                      </div>
                      <div class="status-icon pass">
                        <img src="{% static 'assets/icons/pass.png' %}" alt="Pass" title="Pass" style="width:18px; height:18px;" />
                      </div>
                    </div>
                  </td>
                ` : ''}
              </tr>
            `;
          });
        } else {
          // Fallback: Use the old method if API data is not available
          let totalRows = noOfTrays;
          for (let i = 0; i < totalRows; i++) {
            const trayQty = trayQtyList[i] || trayCapacity;
            html += `
              <tr>
                <td>${i === 0 ? '1 (Top Tray)' : (i + 1)}</td>
                <td>
                  <input type="text" class="form-control" value="" readonly style="width: 100%;" />
                </td>
                <td>
                  <input type="number" class="form-control" value="${trayQty}" readonly style="width: 100%;" />
                </td>
                ${showValidationColumn ? `
                  <td>
                    <div class="validation-status">
                      <div class="status-icon fail">
                        <img src="{% static 'assets/icons/fail.png' %}" alt="Fail" title="Fail" style="width:18px; height:18px;" />
                      </div>
                      <div class="status-icon pass">
                        <img src="{% static 'assets/icons/pass.png' %}" alt="Pass" title="Pass" style="width:18px; height:18px;" />
                      </div>
                    </div>
                  </td>
                ` : ''}
              </tr>
            `;
          }
        }
        
        html += `
            </tbody>
          </table>
        `;
        return html;
      }

      // Initially show table with only 3 columns
      detailsDiv.innerHTML = buildTableHTML(false);

      // Store the buildTableHTML function for later use
      modal.buildTableHTML = buildTableHTML;
      modal.traysData = traysData;
      modal.noOfTrays = noOfTrays;
      modal.trayQtyList = trayQtyList;
      modal.trayCapacity = trayCapacity;

      // Show the read-only modal
      if (modal) modal.style.display = "block";
      modal.classList.add("open");
    });
  });

  // Close handler for the read-only modal
  const closeBtn = document.getElementById("closeTrayScanModal_DayPlanning");
  if (closeBtn) {
    closeBtn.addEventListener("click", function () {
      const modal = document.getElementById("trayScanModal_DayPlanning");
      if (modal) {
        modal.classList.remove("open");
        modal.style.display = "none";
      }
    });
  }
});
</script>

<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  const redoBtn = document.getElementById("trayScanRedoBtn");
  const validateInput = document.getElementById("trayValidateInput");
  const detailsDiv = document.getElementById("trayScanDetails_DayPlanning");
  const errorMessage = document.getElementById("trayErrorMessage");

  if (redoBtn && validateInput && detailsDiv) {
    redoBtn.addEventListener("click", function () {
      // Hide and clear the input
      validateInput.value = "";
      validateInput.blur();
      
      // Hide error message
      if (errorMessage) {
        errorMessage.style.display = "none";
      }
      
      // Reset Tray Validate button to normal state
      const validateBtn = document.getElementById("trayValidateBtn");
      if (validateBtn) {
        validateBtn.style.background = "#f5faff";
        validateBtn.style.borderColor = "#023E4DCC";
        validateBtn.style.color = "#023E4DCC";
      }

      // Reset all icons in the validation status column (read-only modal)
      // For table layout:
      const rows = detailsDiv.querySelectorAll("tbody tr");
      if (rows.length > 0) {
        rows.forEach(row => {
          const statusCell = row.querySelector("td:last-child");
          if (statusCell) {
            statusCell.innerHTML = `
              <div class="validation-status">
                <div class="status-icon fail">
                  <img src="{% static 'assets/icons/fail.png' %}" alt="Fail" title="Fail" style="width:18px; height:18px;" />
                </div>
                <div class="status-icon pass">
                  <img src="{% static 'assets/icons/pass.png' %}" alt="Pass" title="Pass" style="width:18px; height:18px;" />
                </div>
              </div>
            `;
          }
        });
      } else {
        // For grid layout (if used)
                    detailsDiv.querySelectorAll('.tray-validation-status-header, .tray-validation-status-cell').forEach(cell => {
          cell.innerHTML = `
            Tray Validation Status
            <span style="margin-left: 10px;">
              <img src="{% static 'assets/icons/fail.png' %}" alt="Cross" title="Fail" style="width:18px; height:18px; margin-right:6px; vertical-align:middle;" />
              <img src="{% static 'assets/icons/pass.png' %}" alt="Pass" title="Pass" style="width:18px; height:18px; vertical-align:middle;" />
            </span>
          `;
        });
      }
    });
  }
});
</script>

<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  const validateBtn = document.getElementById("trayValidateBtn");
  const validateInput = document.getElementById("trayValidateInput");
  const redoBtn = document.getElementById("trayScanRedoBtn");
  const errorMessage = document.getElementById("trayErrorMessage");

  if (validateBtn && validateInput) {
    validateBtn.addEventListener("click", function () {
      validateInput.value = "";
      
      // Hide error message when starting new validation
      if (errorMessage) {
        errorMessage.style.display = "none";
      }
      
      // Change button to active state (green color)
      validateBtn.style.background = "#e8f5e8";
      validateBtn.style.borderColor = "#4caf50";
      validateBtn.style.color = "#2e7d32";
      
      // Add the 4th column to the table
      const modal = document.getElementById("trayScanModal_DayPlanning");
      const detailsDiv = document.getElementById("trayScanDetails_DayPlanning");
      
      if (modal && detailsDiv && modal.buildTableHTML) {
        // Rebuild table with validation column
        detailsDiv.innerHTML = modal.buildTableHTML(true);
      }
      
      // Focus the hidden input so it can receive keystrokes
      validateInput.focus();
    });
  }
  
  if (redoBtn && validateInput) {
    redoBtn.addEventListener("click", function () {
      validateInput.value = "";
      validateInput.blur();
      
      // Hide error message
      if (errorMessage) {
        errorMessage.style.display = "none";
      }
      
      // Reset button to normal state (original blue color)
      if (validateBtn) {
        validateBtn.style.background = "#f5faff";
        validateBtn.style.borderColor = "#023E4DCC";
        validateBtn.style.color = "#023E4DCC";
      }
      
      // Remove the 4th column from the table
      const modal = document.getElementById("trayScanModal_DayPlanning");
      const detailsDiv = document.getElementById("trayScanDetails_DayPlanning");
      
      if (modal && detailsDiv && modal.buildTableHTML) {
        // Rebuild table without validation column
        detailsDiv.innerHTML = modal.buildTableHTML(false);
      }
      
      redoBtn.focus();
    });
  }
});
</script>

<!-- Script for Tray Validate Status column -- enable/disable of table column -->
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  const validateInput = document.getElementById("trayValidateInput");
  const detailsDiv = document.getElementById("trayScanDetails_DayPlanning");
  const errorMessage = document.getElementById("trayErrorMessage");
  const errorText = document.getElementById("trayErrorText");

  function getCurrentBatchId() {
    const modal = document.getElementById("trayScanModal_DayPlanning");
    if (modal && modal.dataset.batchId) return modal.dataset.batchId;
    const lastBtn = document.querySelector('.tray-scan-btn-DayPlanning-view[data-batch-id]');
    return lastBtn ? lastBtn.getAttribute('data-batch-id') : '';
  }

  function showError(message) {
    if (errorMessage && errorText) {
      errorText.textContent = message;
      errorMessage.style.display = "block";
      // Auto-hide after 5 seconds
      setTimeout(() => {
        errorMessage.style.display = "none";
      }, 5000);
    }
  }

  function hideError() {
    if (errorMessage) {
      errorMessage.style.display = "none";
    }
  }

  if (validateInput && detailsDiv) {
    validateInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        const trayId = validateInput.value.trim();
        if (!trayId) return;
        const batchId = getCurrentBatchId();
        if (!batchId) return;

        // Hide any existing error message
        hideError();

        fetch("/dayplanning/tray_validate/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie('csrftoken')
          },
          body: JSON.stringify({
            batch_id: batchId,
            tray_id: trayId
          })
        })
        .then(res => res.json())
        .then(data => {
          // Find the row in the table with this Tray ID
          const rows = detailsDiv.querySelectorAll("tbody tr");
          let found = false;
          rows.forEach(row => {
            const trayIdInput = row.querySelector('input[type="text"]');
            if (trayIdInput && trayIdInput.value.trim() === trayId) {
              found = true;
              const statusCell = row.querySelector("td:last-child");
              if (statusCell) {
                if (data.success && data.exists) {
                  // Pass validation - show tick as active, cross as inactive
                  statusCell.innerHTML = `
                    <div class="validation-status">
                      <div class="status-icon fail inactive">
                        <img src="{% static 'assets/icons/fail.png' %}" alt="Fail" title="Fail" style="width:18px; height:18px;" />
                      </div>
                      <div class="status-icon pass active">
                        <img src="{% static 'assets/icons/pass.png' %}" alt="Pass" title="Pass" style="width:18px; height:18px;" />
                      </div>
                    </div>
                  `;
                } else {
                  // Fail validation - show cross as active, tick as inactive
                  statusCell.innerHTML = `
                    <div class="validation-status">
                      <div class="status-icon fail active">
                        <img src="{% static 'assets/icons/fail.png' %}" alt="Fail" title="Fail" style="width:18px; height:18px;" />
                      </div>
                      <div class="status-icon pass inactive">
                        <img src="{% static 'assets/icons/pass.png' %}" alt="Pass" title="Pass" style="width:18px; height:18px;" />
                      </div>
                    </div>
                  `;
                }
              }
            }
          });
          
          if (!found) {
            // Show inline error message instead of SweetAlert
            showError(`Tray ID "${trayId}" not found in table.`);
          }
          
          // --- Always clear and focus input for next scan ---
          validateInput.value = "";
          validateInput.focus();
        })
        .catch(error => {
          console.error('Error:', error);
          showError('An error occurred while validating the tray ID.');
          validateInput.value = "";
          validateInput.focus();
        });
      }
    });
  }
  
  // Helper for CSRF
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>

<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll('.process-status-w').forEach(function(radio) {
    radio.addEventListener('change', function() {
      if (this.checked) {
        const row = this.closest('tr');
        const lotId = row.getAttribute('data-stock-lot-id') || 
                     row.querySelector('.ip-checkbox')?.getAttribute('data-lot-id');
        
        if (!lotId) {
          Swal.fire('Error', 'Lot ID not found for this row.', 'error');
          this.checked = false;
          return;
        }
        
        // Make API call to save wiping status
        fetch('/inputscreening/save_wiping_status/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
            lot_id: lotId,
            wiping_status: true
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // Show success message
            showSuccessNotification('Wiping status updated successfully!');
            
            // Transform the radio button + label into a green filled circle like Q and S
            const label = this.parentElement;
            const processStatusGroup = label.parentElement;
            
            // Create the new green filled W icon
            const wIcon = document.createElement('div');
            wIcon.title = "Wiping Completed";
            wIcon.className = "d-flex align-items-center justify-content-center rounded-circle";
            wIcon.style.cssText = `
              width: 28px; 
              height: 28px; 
              background-color: #0c8249; 
              color: white; 
              font-weight: bold; 
              font-size: 15px;
            `;
            wIcon.textContent = 'W';
            
            // Replace the radio button + label with the new icon
            processStatusGroup.replaceChild(wIcon, label);
            
            console.log('Wiping status saved for lot:', lotId);
          } else {
            Swal.fire('Error', data.error || 'Failed to save wiping status', 'error');
            this.checked = false;
          }
        })
        .catch(error => {
          console.error('Error saving wiping status:', error);
          Swal.fire('Error', 'Network error occurred while saving wiping status', 'error');
          this.checked = false;
        });
      }
    });
  });
  
  // Function to check and set initial wiping status on page load
  function loadWipingStatuses() {
    document.querySelectorAll('.process-status-w').forEach(function(radio) {
      const row = radio.closest('tr');
      const lotId = row.getAttribute('data-stock-lot-id') || 
                   row.querySelector('.ip-checkbox')?.getAttribute('data-lot-id');
      
      if (lotId) {
        // Check current wiping status from server
        fetch(`/inputscreening/get_wiping_status/?lot_id=${encodeURIComponent(lotId)}`)
          .then(res => res.json())
          .then(data => {
            if (data.success && data.wiping_status) {
              // Transform the radio button + label into a green filled circle like Q and S
              const label = radio.parentElement;
              const processStatusGroup = label.parentElement;
              
              // Create the new green filled W icon
              const wIcon = document.createElement('div');
              wIcon.title = "Wiping Completed";
              wIcon.className = "d-flex align-items-center justify-content-center rounded-circle";
              wIcon.style.cssText = `
                width: 28px; 
                height: 28px; 
                background-color: #0c8249; 
                color: white; 
                font-weight: bold; 
                font-size: 15px;
              `;
              wIcon.textContent = 'W';
              
              // Replace the radio button + label with the new icon
              processStatusGroup.replaceChild(wIcon, label);
            }
          })
          .catch(error => {
            console.error('Error loading wiping status for lot:', lotId, error);
          });
      }
    });
  }
  
  // Load initial statuses
  loadWipingStatuses();
});

// Helper function for success notifications (reuse existing one if available)
function showSuccessNotification(message) {
  let notification = document.getElementById('success-notification');
  if (!notification) {
    notification = document.createElement('div');
    notification.id = 'success-notification';
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10001;
      font-weight: 500;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    `;
    document.body.appendChild(notification);
  }
  
  notification.textContent = message;
  
  // Show notification
  setTimeout(() => {
    notification.style.transform = 'translateX(0)';
  }, 100);
  
  // Hide notification after 3 seconds
  setTimeout(() => {
    notification.style.transform = 'translateX(400px)';
  }, 3000);
}
</script>

<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll('.ip-checkbox').forEach(function (checkbox) {
    const row = checkbox.closest('tr');
    const lotQtySpan = row.querySelector('.lot-qty');
    const totalQty = parseInt(lotQtySpan.textContent.trim(), 10);
    const missingQtyInput = row.querySelector('.missing-qty-input');
    const physicalQtyInput = row.querySelector('.physical-qty-input');

    // Enable input on page load if not checked/disabled
    if (!checkbox.checked && !checkbox.disabled) {
      missingQtyInput.disabled = false;
    }

    // Live update physical qty as user types
    missingQtyInput.addEventListener('input', function () {
      let missingQty = parseInt(missingQtyInput.value, 10);
      if (isNaN(missingQty) || missingQty < 0) {
        physicalQtyInput.value = totalQty;
        return;
      }
      if (missingQty > totalQty) {
        missingQtyInput.value = totalQty;
        missingQty = totalQty;
      }
      physicalQtyInput.value = totalQty - missingQty;
    });

    // Handle saving when missing qty input loses focus
    missingQtyInput.addEventListener('blur', function() {
      if (checkbox.checked && !checkbox.disabled && missingQtyInput.value.trim()) {
        saveCheckboxData();
      }
    });
    
    // Handle saving when Enter is pressed in missing qty input
    missingQtyInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && checkbox.checked && !checkbox.disabled) {
        saveCheckboxData();
      }
    });

    // Handle checkbox click - combined functionality
    checkbox.addEventListener('change', function () {
      if (this.checked && !this.disabled) {
        // Enable input and focus
        missingQtyInput.disabled = false;
        missingQtyInput.focus();
        
        // Validate and save if there's already a value
        const lotId = checkbox.getAttribute('data-lot-id');
        let missingQty = missingQtyInput.value.trim();
        
        if (!lotId) {
          Swal.fire('Error', 'Lot ID not found.', 'error');
          checkbox.checked = false;
          return;
        }
        
        if (missingQty && !isNaN(missingQty) && parseInt(missingQty) >= 0) {
          // Save immediately if valid value exists
          saveCheckboxData();
        } else if (!missingQty) {
          // If no value, just enable input for user to enter
          return;
        } else {
          // Invalid value
          Swal.fire('Error', 'Enter a valid missing quantity.', 'error');
          checkbox.checked = false;
          return;
        }
      } else {
        // Reset when unchecked
        missingQtyInput.value = '';
        missingQtyInput.disabled = false;
        if (physicalQtyInput) physicalQtyInput.value = totalQty;
      }
    });
    
    // Function to save checkbox data
    function saveCheckboxData() {
      const lotId = checkbox.getAttribute('data-lot-id');
      let missingQty = missingQtyInput.value.trim();
      
      if (!lotId) {
        Swal.fire('Error', 'Lot ID not found.', 'error');
        checkbox.checked = false;
        return;
      }
      if (!missingQty || isNaN(missingQty) || parseInt(missingQty) < 0) {
        Swal.fire('Error', 'Enter a valid missing quantity.', 'error');
        checkbox.checked = false;
        return;
      }
      
      // Make API call to save
      fetch('/inputscreening/save_ip_checkbox/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          lot_id: lotId,
          missing_qty: missingQty
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // Update checkbox and input states
          checkbox.checked = true;
          checkbox.disabled = true;
          missingQtyInput.disabled = true;
          if (physicalQtyInput) {
            physicalQtyInput.value = totalQty - parseInt(missingQty);
          }
          
          // Reload page to reset state
          window.location.reload();

          // Update process status icon to green
          const processIcons = row.querySelectorAll('.d-flex > div');
          if (processIcons.length > 0) {
            processIcons[0].style.backgroundColor = '#0c8249';
          }
      
          // Update Action column - Enable icons and buttons
          updateActionColumn();
          
          // Update Remarks column - Enable icons
          updateRemarksColumn();

          // Enable Accept and Reject buttons
          const acceptBtn = row.querySelector('.btn-twitter');
          const rejectBtn = row.querySelector('.btn-youtube');
          if (acceptBtn) acceptBtn.disabled = false;
          if (rejectBtn) rejectBtn.disabled = false;
          
        } else {
          Swal.fire('Error', data.error || 'Failed to save checkbox', 'error');
          checkbox.checked = false;
        }
      })
      .catch(() => {
        Swal.fire('Error', 'Network error', 'error');
        checkbox.checked = false;
      });
    }
    
    // Function to update action column
    function updateActionColumn() {
      const actionTd = row.cells[16]; // Action column
      if (actionTd) {
        actionTd.innerHTML = `
          <a href="#" class="edit-qty-btn" data-batch-id="${row.getAttribute('data-batch-id')}">
            <img src="{% static 'assets/icons/edit1.png' %}" alt="Edit" style="width: 28px; margin-right: 8px; height: auto"/>
          </a>
          <a href="#" class="delete-batch-btn" title="Delete" data-batch-id="${row.getAttribute('data-batch-id')}" data-stock-lot-id="${checkbox.getAttribute('data-lot-id')}">
            <img src="{% static 'assets/icons/bin.png' %}" alt="Delete" style="width: 20px; margin-right: 8px; height: auto" />
          </a>
          <button type="button" class="btn btn-social-icon-text btn-twitter"
                  style="background-color: #66bb6a;"
                  data-lot-id="${checkbox.getAttribute('data-lot-id')}">
            <i class="fa fa-check-circle"></i>Accept
          </button>
          <button type="button" class="btn btn-social-icon-text btn-youtube tray-scan-btn"
                  style="background-color: #e57373;"
                  data-stock-lot-id="${checkbox.getAttribute('data-lot-id')}"
                  data-batch-id="${row.getAttribute('data-batch-id')}">
            <i class="fa fa-times-circle"></i>Reject
          </button>
          <a href="#" title="View" class="text-primary tray-scan-btn-DayPlanning-view tray-scan-btn-Jig"
             style="text-decoration: underline"
             data-stock-lot-id="${checkbox.getAttribute('data-lot-id')}"
             data-batch-id="${row.getAttribute('data-batch-id')}"
             data-model-no="${row.getAttribute('data-model-no')}"
             data-no-of-trays="${row.getAttribute('data-no-of-trays') || ''}"
             data-tray-capacity="${row.getAttribute('data-tray-capacity') || '0'}"
             data-moved-to-d-picker="${row.getAttribute('data-moved-to-d-picker') || ''}"
             data-tray-qty-list="${row.getAttribute('data-tray-qty-list') || '[]'}">
            <img src="{% static 'assets/icons/view.png' %}" alt="View" style="width: 20px; margin-right: 8px; height: auto; cursor:pointer;" />
          </a>
        `;
      }
    }
    
    // Function to update remarks column
    function updateRemarksColumn() {
      const remarksCell = row.cells[19]; // Remarks column
      if (remarksCell) {
        remarksCell.innerHTML = `
          <a href="#" title="Add Audio Remark" class="remark-tooltip-trigger" style="display: inline-flex; align-items: center; height: 28px; margin-left: 0; position: relative; cursor: pointer;">
            <img src="{% static 'assets/icons/rec.png' %}" alt="VoiceRec" style="width: 20px; height: 20px"/>
            <div class="remark-tooltip" style="position: absolute; top: 110%; left: 50%; transform: translateX(-50%); width: 300px; background: #fff; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; padding: 15px; z-index: 1000;">
              <div style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 10px solid #fff;"></div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <button type="button" style="background: #28a745; color: #fff; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; display: flex; align-items: center; justify-content: center;">
                  <i class="fa fa-microphone"></i>
                </button>
                <span style="font-size: 14px; color: #333;">Hold to record audio</span>
              </div>
              <div style="text-align: right; margin-top: 10px;">
                <button type="button" style="background-color: #007bff; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                  <i class="fa fa-send"></i>
                </button>
              </div>
            </div>
          </a>
          <a href="#" title="Add Remark" class="remark-tooltip-trigger" style="display: inline-flex; align-items: center; height: 20px; margin-left: 5px; position: relative; cursor: pointer;">
            <img src="{% static 'assets/icons/chat1.png' %}" alt="Chat" style="width: 20px; height: 20px"/>
            <div class="remark-tooltip" style="position: absolute; top: 110%; left: 50%; transform: translateX(-50%); width: 300px; background: #fff; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; padding: 15px; z-index: 1000;">
              <div style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 10px solid #fff;"></div>
              <textarea placeholder="Type your remark..." style="width: 85%; height: 40px; resize: vertical; border: 1px solid #ccc; padding: 5px; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px;"></textarea>
              <div style="text-align: right; margin-top: -35px">
                <button type="button" style="background-color: #007bff; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                  <i class="fa fa-send"></i>
                </button>
              </div>
            </div>
          </a>
        `;
      }
    }
  });
  
  // Helper function for CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>

<!--Accept functionality-->
<!--Accept functionality - Updated to remove page reload-->
<script nonce="{{csp_nonce}}">
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll('.btn-twitter').forEach(function (acceptBtn) {
    acceptBtn.addEventListener('click', function () {
      if (acceptBtn.disabled) return;
      const row = acceptBtn.closest('tr');
      const lotId = row.querySelector('.ip-checkbox').getAttribute('data-lot-id');
      fetch('/inputscreening/is_accepted_form/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ stock_lot_id: lotId })
      })
      .then(res => {
        if (res.redirected) {
          window.location.href = res.url; // handle Django redirect
          return;
        }
        return res.json();
      })
      .then(data => {
        if (data && data.success) {
          Swal.fire({
            icon: 'success',
            title: 'Accepted successfully!',
            showConfirmButton: false,
            timer: 1200
          }).then(() => {
            // Update UI elements silently instead of reloading page
                        window.location.reload(); // Reload to reset state

            });
        } else if (data && data.error) {
          Swal.fire('Error', data.error, 'error');
        }
      })
      .catch(() => {
        Swal.fire('Error', 'Network error', 'error');
      });
    });
  });
});
</script>

<script nonce="{{ csp_nonce }}">
      document.addEventListener("DOMContentLoaded", function () {
      
        const cancelBtn = document.getElementById("trayScanCancelBtn");
        if (cancelBtn) {
          cancelBtn.addEventListener("click", function () {
            const modal = document.getElementById("trayScanModal_BQ");
            if (modal) modal.classList.remove("open");
          });
        }
      
         // DELETE BUTTON HANDLER
    document.querySelectorAll('.delete-batch-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          const row = btn.closest('tr');
          if (!row) return;
          const batchId = btn.getAttribute('data-batch-id');
          const stockLotId = btn.getAttribute('data-stock-lot-id');
          if (!batchId || !stockLotId) {
            Swal.fire('Error', 'Batch ID or Stock Lot ID not found!', 'error');
            return;
          }
          Swal.fire({
            title: 'Are you sure?',
            text: 'Do you really want to delete this batch?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
          }).then((result) => {
            if (result.isConfirmed) {
              fetch('/inputscreening/ip_delete_batch/', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ batch_id: batchId, stock_lot_id: stockLotId })
              })
              .then(res => res.json())
              .then(data => {
                if (data.success) {
                  row.remove();
                  Swal.fire({
                    icon: 'success',
                    title: 'Deleted!',
                    text: 'Batch has been deleted.',
                    timer: 1200,
                    showConfirmButton: false
                  });                  
                } else {
                  Swal.fire('Error', data.error || 'Delete failed', 'error');
                }
              });
            }
          });
        });
      });

// Updated quantity edit functionality - completely silent, no page reload
document.querySelectorAll('.edit-qty-btn').forEach(function(btn) {
  btn.addEventListener('click', function(e) {
    e.preventDefault(); // Prevent any default behavior
    const row = btn.closest('tr');
    if (!row) return;
    const qtyCell = row.querySelector('.physical-qty-input');
    if (!qtyCell) return;
    const batchId = btn.getAttribute('data-batch-id');
    const oldValue = qtyCell.value.trim();
    
    // Prevent multiple inputs
    if (qtyCell.hasAttribute('data-editing')) return;
    
    qtyCell.setAttribute('data-editing', 'true');
    qtyCell.readOnly = false;
    qtyCell.focus();
    qtyCell.select();

    // Handle Enter key press
    const handleKeyDown = function(ev) {
      if (ev.key === 'Enter') {
        ev.preventDefault(); // Prevent form submission
        const newValue = qtyCell.value.trim();
        
        if (!newValue || isNaN(newValue) || parseInt(newValue) <= 0) {
          showErrorNotification('Enter a valid quantity.');
          resetInput();
          return;
        }
        
        // Make silent API call
        fetch('/inputscreening/ip_update_batch_quantity/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ batch_id: batchId, dp_physical_qty: newValue })
        })
        .then(res => {
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          if (data.success) {
            // Update UI silently
            qtyCell.value = newValue;
            qtyCell.style.backgroundColor = '#fff3cd';
            qtyCell.style.borderColor = '#ffc107';
            qtyCell.title = 'This quantity was edited';
            finishEditing();
            
            // Show silent success notification
            setTimeout(() => {
              showSuccessNotification('Quantity updated successfully!');
            }, 200);
          } else {
            throw new Error(data.error || 'Update failed');
          }
        })
        .catch((error) => {
          console.error('Error updating quantity:', error);
          resetInput();
          showErrorNotification('Failed to update quantity. Please try again.');
        });
      }
      
      if (ev.key === 'Escape') {
        ev.preventDefault();
        resetInput();
      }
    };

    // Handle blur (clicking away)
    const handleBlur = function() {
      resetInput();
    };

    // Helper function to reset input
    function resetInput() {
      qtyCell.value = oldValue;
      finishEditing();
    }

    // Helper function to finish editing
    function finishEditing() {
      qtyCell.readOnly = true;
      qtyCell.removeAttribute('data-editing');
      qtyCell.removeEventListener('keydown', handleKeyDown);
      qtyCell.removeEventListener('blur', handleBlur);
    }

    // Add event listeners
    qtyCell.addEventListener('keydown', handleKeyDown);
    qtyCell.addEventListener('blur', handleBlur, { once: true });
  });
});

// Helper function to show error notification
function showErrorNotification(message) {
  // Create or get existing notification element
  let notification = document.getElementById('error-notification');
  if (!notification) {
    notification = document.createElement('div');
    notification.id = 'error-notification';
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #dc3545;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(220,53,69,0.15);
      z-index: 10001;
      font-weight: 500;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    `;
    document.body.appendChild(notification);
  }
  
  notification.textContent = message;
  
  // Show notification
  setTimeout(() => {
    notification.style.transform = 'translateX(0)';
  }, 100);
  
  // Hide notification after 4 seconds (longer for errors)
  setTimeout(() => {
    notification.style.transform = 'translateX(400px)';
  }, 4000);
}

const table = document.getElementById("order-listing");
        if (!table) {
          console.warn("Table with ID 'order-listing' not found.");
          return;
        }
      
        const headers = table.querySelectorAll("thead th");
        const tbody = table.querySelector("tbody");
      
        let sortDirection = {};
      
        headers.forEach((header, index) => {
          header.style.cursor = "pointer";
      
          header.addEventListener("click", function () {
            const rows = Array.from(tbody.querySelectorAll("tr"));
            const dir = sortDirection[index] === "asc" ? "desc" : "asc";
            sortDirection[index] = dir;
      
            rows.sort((a, b) => {
              const cellA = a.children[index].textContent.trim();
              const cellB = b.children[index].textContent.trim();
              const valA = isNaN(cellA) ? cellA : parseFloat(cellA);
              const valB = isNaN(cellB) ? cellB : parseFloat(cellB);
      
              if (valA < valB) return dir === "asc" ? -1 : 1;
              if (valA > valB) return dir === "asc" ? 1 : -1;
              return 0;
            });
      
            tbody.innerHTML = "";
            rows.forEach((row) => tbody.appendChild(row));
          });
        });
      });
</script>

    <!-- Tray Scan Modal & New Popup Script -->
    <!-- Tray Scan Modal & New Popup Script -->
<script nonce="{{ csp_nonce }}">
    document.addEventListener("DOMContentLoaded", () => {
      const trayScanLinks = document.querySelectorAll(".tray-scan-btn");
      const trayModal = document.getElementById("trayScanModal");
      const closeTrayBtn = document.getElementById("closeTrayScanModal");
      const detailsDiv = document.getElementById("trayScanDetails");
      const newPopupModal = document.getElementById("newPopupModal");
      const closeNewPopupBtn = document.getElementById("closeNewPopupModal");

      trayScanLinks.forEach((link) => {
        link.addEventListener("click", (event) => {
          event.preventDefault();

          const row = event.target.closest("tr");
          const batchId = link.getAttribute('data-batch-id');
          const stockLotId = link.getAttribute('data-stock-lot-id');
          const isOnHold = row.getAttribute('data-ip-onhold-picking') === 'True'; // Check if ip_onhold_picking is True
   
          trayModal.dataset.batchId = batchId;
          trayModal.dataset.stockLotId = stockLotId;

          const dateTime = row.cells[1].textContent.trim();
          const totalQuantity = row.cells[10].textContent.trim();
          const modelNo = row.getAttribute('data-model-no') || '';
          const modalHeader = document.getElementById("trayScanModalHeader");
          if (modalHeader) {
            modalHeader.innerHTML = `Input Screening / <span class="modal-model-no">${modelNo}</span> / Rejection Window`;
          }

          // If ip_onhold_picking is True, show read-only saved data
          if (isOnHold) {
            showReadOnlyRejectionData(stockLotId, detailsDiv);
          } else {
            // Show editable rejection form (existing code)
            showEditableRejectionForm(stockLotId, batchId, detailsDiv, row);
          }

          trayModal.classList.add("open");
        });
      });

      // Function to show read-only saved rejection data
      function showReadOnlyRejectionData(lotId, detailsDiv) {
        fetch(`/inputscreening/ip_get_rejected_tray_scan_data/?lot_id=${encodeURIComponent(lotId)}`)
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              let totalSavedQty = 0;
              let tableRows = '';
              
              data.rows.forEach((row, index) => {
                totalSavedQty += parseInt(row.qty) || 0;
                tableRows += `
                  <tr>
                    <td>${index + 1}</td>
                    <td style="color: #666;">${row.reason_id}</td>
                    <td style="color: #666;">${row.reason}</td>
                    <td>
                      <input type="number" value="${row.qty}" class="form-control" style="width: 80px; background-color: #f5f5f5;" readonly />
                    </td>
                    <td>
                      <input type="text" value="${row.tray_id}" class="form-control" style="width: 120px; background-color: #f5f5f5;" readonly />
                    </td>
                  </tr>
                `;
              });

              detailsDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2" style="padding: 10px 0;">
                  <h4 class="mb-0">Saved Rejection Details</h4>
                  <div class="alert alert-info" style="margin: 0; padding: 8px 12px; font-size: 14px;">
                    <i class="fa fa-info-circle"></i> This data is already saved and cannot be modified
                  </div>
                </div>
                
                <div class="table-responsive" style="border: solid 1px black;">
                  <table class="table table-bordered text-center" style="border: solid 2px black; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead style="border: solid 2px black; background-color: #6c757d; color: #fff;">
                      <tr style="border: solid 1px black;">
                        <th style="padding: 12px;">S.No</th>
                        <th style="padding: 12px;">Reason ID</th>
                        <th style="padding: 12px;">Rejection Reason</th>
                        <th style="padding: 12px;">Quantity</th>
                        <th style="padding: 12px;">Tray</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${tableRows}
                      <tr style="background-color: #f8f9fa; font-weight: bold;">
                        <td colspan="3" style="text-align: right; font-weight: bold;">Total Saved Qty</td>
                        <td style="font-weight: bold; color: #dc3545;">${totalSavedQty}</td>
                        <td></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <br>
                
                <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
                  <button id="proceedReadOnlyButton" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 30px;">
                    Proceed
                  </button>
                  <button id="closeReadOnlyModal" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 30px;">
                    Close
                  </button>
                </div>
              `;

              // Add close button event listener
              const closeBtn = document.getElementById("closeReadOnlyModal");
              if (closeBtn) {
                closeBtn.addEventListener("click", () => {
                  trayModal.classList.remove("open");
                });
              }

              // Add proceed button event listener for read-only mode
              const proceedBtn = document.getElementById("proceedReadOnlyButton");
              if (proceedBtn) {
                proceedBtn.addEventListener("click", () => {
                  // First check if draft exists
                  fetch(`/inputscreening/ip_check_accepted_tray_draft/?lot_id=${encodeURIComponent(lotId)}`)
                    .then(res => res.json())
                    .then(draftData => {
                      if (draftData.has_draft) {
                        // Show draft data in editable mode
                        showReadOnlyAcceptedTrayData(lotId, detailsDiv);
                      } else {
                        // Proceed with normal flow - fetch and show fresh accepted tray data
                        fetchAndShowAcceptedTrayData(lotId);
                      }
                    })
                    .catch(error => {
                      console.error('Error checking draft:', error);
                      // Fallback to normal flow
                      fetchAndShowAcceptedTrayData(lotId);
                    });
                });
              }
            } else {
              detailsDiv.innerHTML = `
                <div class="alert alert-warning text-center">
                  <i class="fa fa-exclamation-triangle"></i>
                  No saved rejection data found for this lot.
                </div>
                <div style="display: flex; justify-content: center; margin-top: 20px;">
                  <button id="closeEmptyModal" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 30px;">
                    Close
                  </button>
                </div>
              `;
              
              const closeBtn = document.getElementById("closeEmptyModal");
              if (closeBtn) {
                closeBtn.addEventListener("click", () => {
                  trayModal.classList.remove("open");
                });
              }
            }
          })
          .catch(error => {
            console.error('Error fetching rejection data:', error);
            detailsDiv.innerHTML = `
              <div class="alert alert-danger text-center">
                <i class="fa fa-exclamation-circle"></i>
                Error loading rejection data. Please try again.
              </div>
              <div style="display: flex; justify-content: center; margin-top: 20px;">
                <button id="closeErrorModal" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 30px;">
                  Close
                </button>
              </div>
            `;
            
            const closeBtn = document.getElementById("closeErrorModal");
            if (closeBtn) {
              closeBtn.addEventListener("click", () => {
                trayModal.classList.remove("open");
              });
            }
          });
      }

      // Function to fetch and show normal accepted tray data
      function fetchAndShowAcceptedTrayData(lotId) {
        fetch(`/inputscreening/get_accepted_tray_scan_data/?lot_id=${encodeURIComponent(lotId)}`)
          .then(res => res.json())
          .then(rescanData => {
            if (rescanData.success) {
              showAcceptedTrayModal(rescanData, lotId, false);
            }
          })
          .catch(error => {
            console.error('Error fetching accepted tray data:', error);
            alert('Error loading accepted tray data. Please try again.');
          });
      }

      // Function to show read-only accepted tray data (for draft mode)
      function showReadOnlyAcceptedTrayData(lotId, detailsDiv) {
        fetch(`/inputscreening/get_accepted_tray_scan_data/?lot_id=${encodeURIComponent(lotId)}`)
          .then(res => res.json())
          .then(data => {
            if (data.success && data.has_draft) {
              showAcceptedTrayModal(data, lotId, true);
            } else {
              // No draft exists, proceed with normal flow
              fetchAndShowAcceptedTrayData(lotId);
            }
          })
          .catch(error => {
            console.error('Error checking draft data:', error);
            // Fallback to normal flow
            fetchAndShowAcceptedTrayData(lotId);
          });
      }

// Updated showAcceptedTrayModal function with Top Tray Verification
function showAcceptedTrayModal(rescanData, lotId, isDraft) {
  let rows = rescanData.rows || [];   
  let modelNo = rescanData.model_no;
  let topTrayVerified = rescanData.top_tray_verified || false; // Get from backend
  let verifiedTrayQty = rescanData.verified_tray_qty || 0; // Get from backend
  
  rows.sort((a, b) => parseInt(a.tray_qty) - parseInt(b.tray_qty));
  
  // Reassign S.no after sorting
  rows.forEach((row, idx) => {
    row.sno = idx + 1;
  });

  // Calculate total capacity for tray scan counter
  let totalCapacity = 0;
  rows.forEach(row => {
    totalCapacity += parseInt(row.tray_qty) || 0;
  });

  let draftIndicator = isDraft ? ' (Draft)' : '';
  let draftAlert = isDraft ? `
    <div class="alert alert-info" style="margin: 10px 0; padding: 8px 12px; font-size: 14px;">
      <i class="fa fa-info-circle"></i> This is draft data. You can edit and save changes.
    </div>
  ` : '';

  let html = `
    <div class="modal-top-header" style="display: flex; align-items: center; gap: 20px; padding-bottom: 10px;">
      <div class="user-profile" style="display: flex; align-items: center; gap: 8px">
        <img src="/static/assets/images/imagePlaceholder.png" alt="User Profile" style="border-radius: 50%; width: 50px; height: 50px; object-fit: cover;" />
        <span>Model No:</span>
        <h6>${modelNo} / Accepted Tray Rescan${draftIndicator}</h6>
      </div>
    </div>
    ${draftAlert}
    
    <!-- Header with Tray Scan Counter and Redo Button -->
        <!-- Delink Table" -->
                <!-- Add this block above the existing content -->
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
          <!-- Title on the left -->
          <h5 style="margin: 0; font-weight: 600; color: #595959;">Delink</h5>
          
          <!-- Redo icon and Scan Qty counter on the right -->
          <div style="display: flex; align-items: center; gap: 15px;">
            <!-- Redo Icon -->
            <img src="{% static 'assets/icons/redo2.png' %}" alt="Redo" style="width: 24px; height: 24px; cursor: pointer;" title="Clear Delink IDs" />
            
            <!-- Scan Qty Counter -->
            <div style="display: flex; align-items: center; gap: 8px; background: #f8f9fa; padding: 6px 12px; border-radius: 20px; border: 1px solid #dee2e6;">
              <span style="font-size: 14px; font-weight: 600; color: #028084;">Scan Qty:</span>
              <span style="font-size: 14px; font-weight: bold; color: #dc3545;">10/10</span>
            </div>
          </div>
        </div>
    <div class="table-responsive" style="margin-bottom: 20px; border: solid 1px black;">
      <table class="table table-bordered text-center" style="border: solid 2px black; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <thead style="background-color: #007bff; color: #fff;">
          <tr>
            <th style="padding: 12px;">S.No</th>
            <th style="padding: 12px;">De-Link Tray ID</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td>Static Row 1</td>
          </tr>
          <tr>
            <td>2</td>
            <td>Static Row 2</td>
          </tr>
          <tr>
            <td>3</td>
            <td>Static Row 3</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">


      
      <h5 style="margin: 0; font-weight: 600; color:#595959">
        Accepted case tray scan table${isDraft ? ' (Draft Mode)' : ''}
      </h5>
      
      <div style="display: flex; align-items: center; gap: 15px;">
        <!-- Tray Scan Counter -->
        <div style="display: flex; align-items: center; gap: 8px; background: #f8f9fa; padding: 6px 12px; border-radius: 20px; border: 1px solid #dee2e6;">
          <span style="font-size: 14px; font-weight: 600; color: #028084;">Scan Qty:</span>
          <span id="trayScanCounter" style="font-size: 14px; font-weight: bold; color: #dc3545;" data-total="${totalCapacity}">${totalCapacity}/${totalCapacity}</span>
        </div>
        <!-- Redo Button -->
        <img src="{% static 'assets/icons/redo2.png' %}" alt="Redo" id="acceptedTrayRedoBtn" 
             style="width: 24px; height: 24px; cursor: pointer;" title="Clear Tray IDs" />
      </div>
    </div>
    
    <div id="trayScanDetails" class="table-grid">
      <div style="border: 1px solid #ccc; padding: 8px; font-weight: bold;">S.no</div>
      <div style="border: 1px solid #ccc; padding: 8px; font-weight: bold;">Tray ID</div>
      <div style="border: 1px solid #ccc; padding: 8px; font-weight: bold;">Tray Qty</div>
  `;

  rows.forEach((row, index) => {
    let inputStyle = isDraft ? 'width:90px; background-color: #f0f8ff;' : 'width:90px;';
    let isTopTray = index === 0;
    let topTrayQty = isTopTray && verifiedTrayQty > 0 ? verifiedTrayQty : row.tray_qty;
    
    html += `
      <div style="border: 1px solid #ccc; padding: 8px;">${isTopTray ? '1 (Top Tray)' : row.sno}</div>
      <div style="border: 1px solid #ccc; padding: 8px;">
        <input type="text" value="${row.tray_id}" style="${inputStyle}" class="accepted-tray-id-input" data-row="${row.sno}" data-tray-qty="${row.tray_qty}" />
        <span class="tray-id-error" style="display:none; color:#d32f2f; font-size:12px; margin-left:4px;"></span>
      </div>
      <div style="border: 1px solid #ccc; padding: 8px;">
        ${isTopTray ? `
          <!-- Top Tray Quantity with Icons -->
          <div style="display: flex; align-items: center; gap: 8px;">
            <input type="number" 
                   value="${topTrayQty}" 
                   style="width:60px; background-color: ${topTrayVerified ? '#f5f5f5' : '#fff'};" 
                   class="top-tray-qty-input"
                   ${topTrayVerified ? 'readonly' : 'readonly'}
                   data-original-qty="${row.tray_qty}" />
            
            <!-- Edit Icon -->
            <img src="{% static 'assets/icons/edit1.png' %}" 
                 alt="Edit" 
                 class="edit-top-tray-btn" 
                 style="width: 18px; height: 18px; cursor: pointer; ${topTrayVerified ? 'opacity: 0.5; pointer-events: none;' : ''}" 
                 title="Edit Top Tray Quantity" />
            
            <!-- Check Icon -->
            <input type="checkbox" 
                   class="verify-top-tray-checkbox" 
                   style="width: 18px; height: 18px; cursor: pointer;" 
                   ${topTrayVerified ? 'checked disabled' : ''}
                   title="Verify Top Tray Quantity" />
          </div>
        ` : `
          <input type="number" value="${row.tray_qty}" style="width:60px; background-color: #f5f5f5;" readonly />
        `}
      </div>
    `;
  });

  // Different buttons based on draft mode
  if (isDraft) {
    html += `
      <div style="grid-column: 1 / -1; display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
        <button id="acceptedTrayUpdateDraftBtn" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 30px;">Update Draft</button>
        <button style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 30px;" id="acceptedTrayFinalSubmitBtn">Final Submit</button>
        <button id="acceptedTrayCancelDraftBtn" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 30px;">
          Cancel
        </button>
      </div>
    `;
  } else {
    html += `
      <div style="grid-column: 1 / -1; display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
        <button id="acceptedTrayDraftBtn" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 30px;">Draft</button>
        <button style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 30px;" id="acceptedTraySubmitBtn">Submit</button>
        <button id="acceptedTrayCancelBtn" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 30px;">
          Cancel
        </button>
      </div>
    `;
  }

  html += `
    <div id="acceptedTrayMsg" style="margin-top: 10px; text-align: center; font-weight: bold;"></div>
  </div>`;
  
  document.querySelector("#newPopupModal .tray-scan-modal-content").innerHTML = html;
  newPopupModal.classList.add("open");
  
  // Initialize tray scan counter
  updateTrayScanCounter();
  
  // Add event listeners based on mode
  if (isDraft) {
    addDraftModeEventListeners(lotId);
  } else {
    addNormalModeEventListeners(lotId);
  }

  // Add tray ID validation for all modes
  addTrayIdValidation(lotId);
  
  // Add redo functionality
  addAcceptedTrayRedoFunctionality();
  
  // Add top tray verification functionality
  addTopTrayVerificationFunctionality(lotId);
}
// Function to add top tray verification functionality
function addTopTrayVerificationFunctionality(lotId) {
  const editBtn = document.querySelector('.edit-top-tray-btn');
  const checkbox = document.querySelector('.verify-top-tray-checkbox');
  let qtyInput = document.querySelector('.top-tray-qty-input'); // Use let instead of const
  
  // Edit button click handler
  if (editBtn && editBtn.style.pointerEvents !== 'none') {
    editBtn.addEventListener('click', function() {
      if (checkbox.checked || checkbox.disabled) return; // Don't allow edit if verified
      
      console.log('Edit button clicked'); // Debug log
      
      // Enable editing
      qtyInput.removeAttribute('readonly');
      qtyInput.style.backgroundColor = '#fff3cd';
      qtyInput.style.borderColor = '#ffc107';
      qtyInput.style.cursor = 'text';
      qtyInput.focus();
      qtyInput.select();
      
      // Get the original tray capacity (maximum allowed)
      const originalQty = parseInt(qtyInput.getAttribute('data-original-qty')) || 0;
      console.log('Original quantity:', originalQty); // Debug log
      
      // Remove any existing event listeners to avoid duplicates
      const newInput = qtyInput.cloneNode(true);
      qtyInput.parentNode.replaceChild(newInput, qtyInput);
      
      // FIX: Update the qtyInput reference to point to the new element
      qtyInput = newInput;
      
      // Re-focus the new input
      newInput.focus();
      newInput.select();
      
      // Add real-time validation
      newInput.addEventListener('input', function(e) {
        let val = parseInt(this.value) || 0;
        console.log('Input value:', val); // Debug log
        
        // Don't allow negative values
        if (val < 0) {
          this.value = 0;
          val = 0;
        }
        
        // Don't allow values greater than original capacity
        if (val > originalQty) {
          this.value = originalQty;
          val = originalQty;
        }
        
        // Update tray scan counter in real-time
        updateTrayScanCounter();
      });
      
      // Handle keydown events
      newInput.addEventListener('keydown', function(e) {
        // Allow: backspace, delete, tab, escape, enter, home, end, left, right, up, down
        if ([46, 8, 9, 27, 13, 35, 36, 37, 39, 38, 40].indexOf(e.keyCode) !== -1 ||
            // Allow Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
            (e.keyCode === 65 && e.ctrlKey === true) ||
            (e.keyCode === 67 && e.ctrlKey === true) ||
            (e.keyCode === 86 && e.ctrlKey === true) ||
            (e.keyCode === 88 && e.ctrlKey === true)) {
          
          if (e.key === 'Enter') {
            e.preventDefault();
            this.blur();
          } else if (e.key === 'Escape') {
            e.preventDefault();
            this.value = originalQty; // Reset to original
            this.blur();
          }
          return;
        }
        
        // Ensure that it's a number and stop the keypress
        if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
          e.preventDefault();
        }
      });
      
      // Handle blur (clicking away or losing focus)
      newInput.addEventListener('blur', function() {
        console.log('Input blur event, current value:', this.value); // Debug log
        
        // Validate final value
        let finalVal = parseInt(this.value) || 0;
        if (finalVal < 0) finalVal = 0;
        if (finalVal > originalQty) finalVal = originalQty;
        this.value = finalVal;
        
        // Set back to readonly
        this.setAttribute('readonly', true);
        this.style.backgroundColor = '#f5f5f5';
        this.style.borderColor = '#ccc';
        this.style.cursor = 'not-allowed';
        
        // Update counter one final time
        updateTrayScanCounter();
        
        console.log('Final value after blur:', this.value); // Debug log
      }, { once: true });
    });
  }
  
  // Checkbox click handler
  if (checkbox && !checkbox.disabled) {
    checkbox.addEventListener('change', function() {
      if (this.checked) {
        // FIX: Get the current input element (which might have been replaced during editing)
        const currentQtyInput = document.querySelector('.top-tray-qty-input');
        const verifiedQty = parseInt(currentQtyInput.value) || 0;
        const originalQty = parseInt(currentQtyInput.getAttribute('data-original-qty')) || 0;
        
        console.log('Checkbox clicked - Current input value:', currentQtyInput.value); // Debug log
        console.log('Verified Qty:', verifiedQty, 'Original Qty:', originalQty); // Debug log
        
        if (verifiedQty <= 0) {
          showTopTrayError('Please enter a valid quantity before verifying.');
          this.checked = false;
          return;
        }
        
        if (!originalQty || originalQty <= 0) {
          showTopTrayError('Original quantity not found. Please refresh and try again.');
          this.checked = false;
          return;
        }
        
        // Save verification to backend
        saveTopTrayVerification(lotId, verifiedQty, originalQty);
      }
    });
  }
}

// Function to save top tray verification - ENHANCED WITH BETTER LOGGING
function saveTopTrayVerification(lotId, verifiedQty, originalQty) {
  // Add validation before sending to server
  if (!lotId) {
    showTopTrayError('Lot ID not found');
    return;
  }
  
  if (!verifiedQty || verifiedQty <= 0) {
    showTopTrayError('Please enter a valid verified quantity');
    return;
  }
  
  if (!originalQty || originalQty <= 0) {
    showTopTrayError('Original quantity not found');
    return;
  }
  
  console.log('=== SENDING TO API ===');
  console.log('Lot ID:', lotId);
  console.log('Verified Qty (edited value):', verifiedQty);
  console.log('Original Qty (capacity):', originalQty);
  console.log('=====================');
  
  const requestBody = {
    lot_id: lotId,
    verified_tray_qty: verifiedQty,  // This should be 8 in your case
    original_tray_qty: originalQty   // This should be 10 in your case
  };
  
  console.log('Request body:', JSON.stringify(requestBody));
  
  fetch('/inputscreening/verify_top_tray_qty/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify(requestBody)
  })
  .then(res => {
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    return res.json();
  })
  .then(data => {
    console.log('=== API RESPONSE ===');
    console.log('Full response:', data);
    console.log('==================');
    
    if (data.success) {
      // Update UI to show verified state
      const qtyInput = document.querySelector('.top-tray-qty-input');
      const editBtn = document.querySelector('.edit-top-tray-btn');
      const checkbox = document.querySelector('.verify-top-tray-checkbox');
      
      if (qtyInput) {
        qtyInput.setAttribute('readonly', true);
        qtyInput.style.backgroundColor = '#f5f5f5';
        qtyInput.style.borderColor = '#28a745';
      }
      
      if (editBtn) {
        editBtn.style.opacity = '0.5';
        editBtn.style.pointerEvents = 'none';
      }
      
      if (checkbox) {
        checkbox.disabled = true;
      }
      
      showTopTraySuccess(`Top tray quantity verified successfully! Saved: ${data.verified_qty}`);
      
      // Update tray scan counter if needed
      updateTrayScanCounter();
      
    } else {
      // Reset checkbox on error
      const checkbox = document.querySelector('.verify-top-tray-checkbox');
      if (checkbox) checkbox.checked = false;
      
      showTopTrayError(data.error || 'Failed to verify top tray quantity');
    }
  })
  .catch(error => {
    console.error('Error verifying top tray:', error);
    // Reset checkbox on error
    const checkbox = document.querySelector('.verify-top-tray-checkbox');
    if (checkbox) checkbox.checked = false;
    
    showTopTrayError('Network error occurred while verifying');
  });
}

// Function to show top tray success message
function showTopTraySuccess(message) {
  const msgDiv = document.getElementById("acceptedTrayMsg");
  if (msgDiv) {
    msgDiv.style.color = "#388e3c";
    msgDiv.textContent = message;
    setTimeout(() => {
      msgDiv.textContent = "";
    }, 3000);
  }
}

// Function to show top tray error message
function showTopTrayError(message) {
  const msgDiv = document.getElementById("acceptedTrayMsg");
  if (msgDiv) {
    msgDiv.style.color = "#d32f2f";
    msgDiv.textContent = message;
    setTimeout(() => {
      msgDiv.textContent = "";
    }, 5000);
  }
}

// Function to update tray scan counter
function updateTrayScanCounter() {
  const counter = document.getElementById('trayScanCounter');
  if (!counter) return;
  
  const totalCapacity = parseInt(counter.getAttribute('data-total')) || 0;
  let remainingCapacity = totalCapacity;
  
  // Calculate remaining capacity based on filled tray IDs
  document.querySelectorAll('.accepted-tray-id-input').forEach(function(input) {
    const trayQty = parseInt(input.getAttribute('data-tray-qty')) || 0;
    const trayId = input.value.trim();
    
    if (trayId) {
      remainingCapacity -= trayQty;
    }
  });
  
  // Ensure remaining capacity doesn't go below 0
  remainingCapacity = Math.max(0, remainingCapacity);
  
  // Update counter display
  counter.textContent = `${remainingCapacity}/${totalCapacity}`;
  
  // Change color based on progress
  if (remainingCapacity === 0) {
    counter.style.color = '#28a745'; // Green when complete
  } else if (remainingCapacity < totalCapacity) {
    counter.style.color = '#ffc107'; // Yellow when in progress
  } else {
    counter.style.color = '#dc3545'; // Red when not started
  }
}

// Function to add redo functionality
function addAcceptedTrayRedoFunctionality() {
  const redoBtn = document.getElementById('acceptedTrayRedoBtn');
  if (!redoBtn) return;
  
  redoBtn.addEventListener('click', function() {
    // Clear all tray ID inputs
    document.querySelectorAll('.accepted-tray-id-input').forEach(function(input) {
      input.value = '';
    });
    
    // Clear all error messages
    document.querySelectorAll('.tray-id-error').forEach(function(error) {
      error.style.display = 'none';
      error.textContent = '';
    });
    
    // Update tray scan counter
    updateTrayScanCounter();
    
    // Show success message
    showRedoSuccessMessage();
    
    // Focus on first input
    const firstInput = document.querySelector('.accepted-tray-id-input');
    if (firstInput) {
      firstInput.focus();
    }
  });
}

// Function to show redo success message
function showRedoSuccessMessage() {
  // Create temporary success message
  const modal = document.getElementById('newPopupModal');
  if (!modal) return;
  
  let successMsg = document.getElementById('redoSuccessMsg');
  if (!successMsg) {
    successMsg = document.createElement('div');
    successMsg.id = 'redoSuccessMsg';
    successMsg.style.cssText = `
      position: absolute;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: #d1edff;
      color: #0056b3;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      z-index: 10001;
      opacity: 0;
      transition: opacity 0.3s ease;
    `;
    modal.appendChild(successMsg);
  }
  
  successMsg.textContent = 'Tray IDs cleared successfully!';
  successMsg.style.opacity = '1';
  
  // Hide message after 2 seconds
  setTimeout(() => {
    successMsg.style.opacity = '0';
  }, 2000);
}
      // Add event listeners for normal mode
      function addNormalModeEventListeners(lotId) {
        // Draft button
        const draftBtn = document.getElementById("acceptedTrayDraftBtn");
        if (draftBtn) {
          draftBtn.addEventListener("click", function () {
            saveTrayData(lotId, true, "Draft saved successfully!");
          });
        }

        // Submit button
        const submitBtn = document.getElementById("acceptedTraySubmitBtn");
        if (submitBtn) {
          submitBtn.addEventListener("click", function () {
            saveTrayData(lotId, false, "Accepted tray scan saved!");
          });
        }

        // Cancel button
        const cancelBtn = document.getElementById("acceptedTrayCancelBtn");
        if (cancelBtn) {
          cancelBtn.addEventListener("click", function () {
            document.getElementById("newPopupModal").classList.remove("open");
            document.getElementById("trayScanModal").classList.remove("open");
            window.location.reload(); // Reload to reset state
          });
        }
      }

      // Add event listeners for draft mode
      function addDraftModeEventListeners(lotId) {
        // Update Draft button
        const updateDraftBtn = document.getElementById("acceptedTrayUpdateDraftBtn");
        if (updateDraftBtn) {
          updateDraftBtn.addEventListener("click", function () {
            saveTrayData(lotId, true, "Draft updated successfully!");
          });
        }
        
        // Final Submit button
        const finalSubmitBtn = document.getElementById("acceptedTrayFinalSubmitBtn");
        if (finalSubmitBtn) {
          finalSubmitBtn.addEventListener("click", function () {
            saveTrayData(lotId, false, "Final submission successful!");
          });
        }
        
        // Cancel button
        const cancelBtn = document.getElementById("acceptedTrayCancelDraftBtn");
        if (cancelBtn) {
          cancelBtn.addEventListener("click", function () {
            document.getElementById("newPopupModal").classList.remove("open");
            document.getElementById("trayScanModal").classList.remove("open");
          });
        }
      }

      // Updated addTrayIdValidation function to include counter updates
function addTrayIdValidation(lotId) {
  document.querySelectorAll('.accepted-tray-id-input').forEach(function(input, idx, allInputs) {
    // Add input event listener to update counter in real-time
    input.addEventListener('input', function() {
      updateTrayScanCounter();
    });
    
    input.addEventListener('blur', function() {
      const trayId = input.value.trim();
      const errorSpan = input.parentElement.querySelector('.tray-id-error');
      errorSpan.textContent = '';
      errorSpan.style.display = 'none';
      
      // Update counter when input loses focus
      updateTrayScanCounter();
      
      if (!trayId) return;

      // Check for duplicate tray ID in other rows
      let duplicateRow = null;
      allInputs.forEach(function(otherInput, otherIdx) {
        if (otherIdx !== idx && otherInput.value.trim() === trayId) {
          duplicateRow = otherInput.dataset.row;
        }
      });
      if (duplicateRow) {
        errorSpan.textContent = `Duplicate Tray ID: "${trayId}" already in row ${duplicateRow}.`;
        errorSpan.style.display = 'inline';
        return;
      }

      // Server check for existence and lot match
      fetch(`/inputscreening/check_tray_id/?tray_id=${encodeURIComponent(trayId)}&lot_id=${encodeURIComponent(lotId)}`)
        .then(res => res.json())
        .then(data => {
          if (!data.exists) {
            if (data.not_in_same_lot) {
              errorSpan.textContent = `Tray ID "${trayId}" is not in the same lot (Row ${input.dataset.row}).`;
            } else if (data.already_rejected) {
              errorSpan.textContent = `Tray ID "${trayId}" is already rejected in IP screen (Row ${input.dataset.row}).`;
            } else {
              errorSpan.textContent = `Tray ID "${trayId}" is not existing (Row ${input.dataset.row}).`;
            }
            errorSpan.style.display = 'inline';
          }
        });
    });
    
    // Add Enter key navigation
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const nextInput = allInputs[idx + 1];
        if (nextInput) {
          nextInput.focus();
        }
      }
    });
  });
}

// Helper function to save tray data - UPDATED to handle draft saving without visible reload
function saveTrayData(lotId, isDraft, successMessage) {
  const rows = [];
  document.querySelectorAll('#newPopupModal .table-grid input[type="text"]').forEach((input, idx) => {
    const tray_id = input.value;
    const qtyInput = input.parentElement.nextElementSibling.querySelector('input[type="number"]');
    const tray_qty = qtyInput ? qtyInput.value : '';
    rows.push({ tray_id, tray_qty });
  });

  fetch('/inputscreening/save_accepted_tray_scan/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({ lot_id: lotId, rows: rows, draft_save: isDraft })
  })
  .then(res => res.json())
  .then(data => {
    const msgP = document.getElementById("acceptedTrayMsg");
    if (data.success) {
      if (msgP) {
        msgP.style.color = "#388e3c";
        msgP.textContent = successMessage;
      }
      // Reload the page after a short delay for user feedback
      setTimeout(function() {
        window.location.reload();
      }, 800);
    } else {
      if (msgP) {
        msgP.style.color = "#d32f2f";
        msgP.textContent = data.error || "Failed to save";
      }
    }
  })
  .catch(error => {
    console.error('Error saving data:', error);
    const msgP = document.getElementById("acceptedTrayMsg");
    if (msgP) {
      msgP.style.color = "#d32f2f";
      msgP.textContent = "Error saving data. Please try again.";
    }
  });
}
// Helper function to update UI after final submit (without page reload)
// Fixed helper function to update UI after final submit (without page reload)
function updateUIAfterFinalSubmit(lotId) {
  // Find the correct row using lot_id (stock_lot_id)
  const mainRow = document.querySelector(`tr[data-stock-lot-id="${lotId}"]`);
  
  if (!mainRow) {
    console.error('Could not find row with lot_id:', lotId);
    // Fallback: try to find by any data attribute that might match
    const fallbackRow = document.querySelector(`tr[data-batch-id]`);
    if (fallbackRow) {
      console.log('Using fallback row selection');
      updateRowUI(fallbackRow);
    }
    return;
  }
  
  updateRowUI(mainRow);
}

// Helper function to update a specific row's UI
function updateRowUI(row) {
  try {
    // 1. Update Action column buttons (column index 14)
    const actionTd = row.cells[16];
    if (actionTd) {
      
      // Disable edit and delete buttons
      const editBtn = actionTd.querySelector('.edit-qty-btn');
      const deleteBtn = actionTd.querySelector('.delete-batch-btn');
      
      if (editBtn) {
        const editImg = editBtn.querySelector('img');
        editBtn.outerHTML = `<span title="Edit Disabled" style="opacity: 0.5; pointer-events: none;">
          <img src="${editImg ? editImg.src : '/static/assets/icons/edit1.png'}" alt="Edit Disabled" 
               style="width: 20px; margin-right: 8px; height: auto; filter: grayscale(1) opacity(0.5);" />
        </span>`;
      }
      
      if (deleteBtn) {
        const deleteImg = deleteBtn.querySelector('img');
        deleteBtn.outerHTML = `<span title="Delete Disabled" style="opacity: 0.5; pointer-events: none;">
          <img src="${deleteImg ? deleteImg.src : '/static/assets/icons/bin.png'}" alt="Delete Disabled" 
               style="width: 20px; margin-right: 8px; height: auto; filter: grayscale(1) opacity(0.5);" />
        </span>`;
      }
      
      // Update Accept/Reject buttons
      const acceptBtn = actionTd.querySelector('.btn-twitter');
      const rejectBtn = actionTd.querySelector('.btn-youtube');
      
      if (acceptBtn) {
        acceptBtn.innerHTML = '<i class="fa fa-check-circle"></i>Accepted';
        acceptBtn.style.backgroundColor = '#66bb6a';
        acceptBtn.style.pointerEvents = 'none';
        acceptBtn.style.opacity = '0.8';
        acceptBtn.style.cursor = 'not-allowed';
        acceptBtn.disabled = true;
      }
      
      if (rejectBtn) {
        rejectBtn.innerHTML = '<i class="fa fa-times-circle"></i>Rejected';
        rejectBtn.style.backgroundColor = '#e57373';
        rejectBtn.style.pointerEvents = 'none';
        rejectBtn.style.opacity = '0.8';
        rejectBtn.style.cursor = 'not-allowed';
        rejectBtn.disabled = true;
      }
    }

    // 2. Update Process Status icons (S icon to green)
    const processIcons = row.querySelectorAll('.d-flex > div');
    if (processIcons.length > 1) {
      processIcons[1].style.backgroundColor = '#0c8249'; // S icon green
    }

    // 3. Update Lot Status (column index 17)
    const batchStatusTd = row.cells[17];
    if (batchStatusTd) {
      batchStatusTd.innerHTML = `
        <div class="d-inline-block px-3 fw-semibold text-center rounded-pill"
            style="border: 2px solid #0d5d17; background-color: #c5f9c2; color: #2f801b; 
                   font-size: clamp(0.3rem, 2vw, 0.875rem); white-space: nowrap; padding: 0.3rem;">
          Yet to Release
        </div>
      `;
    }

    // 4. Update Current Stage (column index 16)
    const currentLocationTd = row.cells[18];
    if (currentLocationTd) {
      currentLocationTd.innerHTML = `
        <div class="d-inline-block px-3 fw-semibold text-center rounded-pill"
            style="border: 2px solid #0d5d17; background-color: #c5f9c2; color: #2f801b; 
                   font-size: clamp(0.75rem, 2vw, 0.875rem); white-space: nowrap; 
                   padding-top: 0.5rem; padding-bottom: 0.5rem;">
          Input screening
        </div>
      `;
    }

    // 5. Disable audio and remark icons (column index 17)
    const remarksCell = row.cells[17];
    if (remarksCell) {
      const audioIcon = remarksCell.querySelector('a[title="Add Audio Remark"]');
      if (audioIcon) {
        const span = document.createElement('span');
        span.title = "Disabled after moved";
        span.style = "display: inline-flex; align-items: center; height: 28px; margin-left: 0; opacity: 0.5; pointer-events: none;";
        span.innerHTML = audioIcon.innerHTML;
        audioIcon.replaceWith(span);
      }
      
      const chatIcon = remarksCell.querySelector('a[title="Add Remark"]');
      if (chatIcon) {
        const span = document.createElement('span');
        span.title = "Disabled after moved";
        span.style = "display: inline-flex; align-items: center; height: 20px; margin-left: 5px; opacity: 0.5; pointer-events: none;";
        span.innerHTML = chatIcon.innerHTML;
        chatIcon.replaceWith(span);
      }
      
      const textarea = remarksCell.querySelector('textarea');
      if (textarea) textarea.setAttribute('readonly', true);
      
      const sendBtn = remarksCell.querySelector('.remark-tooltip button');
      if (sendBtn) sendBtn.style.display = 'none';
    }
    
    console.log('Successfully updated row UI');
    
  } catch (error) {
    console.error('Error updating row UI:', error);
  }
}
// Helper function to show success notification without page reload
function showSuccessNotification(message) {
  // Create or get existing notification element
  let notification = document.getElementById('success-notification');
  if (!notification) {
    notification = document.createElement('div');
    notification.id = 'success-notification';
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10001;
      font-weight: 500;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    `;
    document.body.appendChild(notification);
  }
  
  notification.textContent = message;
  
  // Show notification
  setTimeout(() => {
    notification.style.transform = 'translateX(0)';
  }, 100);
  
  // Hide notification after 3 seconds
  setTimeout(() => {
    notification.style.transform = 'translateX(400px)';
  }, 3000);
}

// Helper function to get CSRF token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
      // Function to show editable rejection form (existing functionality)
      function showEditableRejectionForm(stockLotId, batchId, detailsDiv, row) {
        // Set the inner HTML with Proceed and Cancel buttons tagged with IDs
        detailsDiv.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-2" style="padding: 10px 0;">
            <h4 class="mb-0">Rejection Reason List</h4>
            
            <div class="form-check d-flex align-items-center">
                <input class="form-check-input" type="checkbox" id="batchRejection" />
                <label class="form-check-label ms-2" for="batchRejection">Lot Rejection</label>
            </div>
          </div>
         
          <div class="table-responsive" style="border: solid 1px black;">
            <table class="table table-bordered text-center" style="border: solid 2px black; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
              <thead style="border: solid 2px black; background-color: #007bff; color: #fff;">
              <tr style="border: solid 1px black; background-color: #007bff; color: #fff;">
                  <th style="padding: 12px;">S.No</th>
                  <th style="padding: 12px;">Reason ID</th>
                  <th style="padding: 12px;">Rejection Reason</th>
                  <th style="padding: 12px;">Quantity</th>
                  <th style="padding: 12px;">Tray</th>
              </tr>
              </thead>
               <tbody id="rejection-table-body">
                  {% for reason in ip_rejection_reasons %}
                   <tr data-batch-id="${batchId}" data-stock-lot-id="${stockLotId}">
<td>
  <span style="display:flex; align-items:center; gap:6px;">
    <!-- Hold remark icon -->
    <span class="hold-remark-icon"
          style="display:{% if data.ip_hold_lot %}inline-block{% else %}none{% endif %}; cursor:pointer;"
          title="{% if data.ip_holding_reason %}Holding Reason: {{ data.ip_holding_reason }}{% endif %}{% if data.ip_holding_reason and data.ip_release_reason %}&#10;{% endif %}{% if data.ip_release_reason %}Release Reason: {{ data.ip_release_reason }}{% endif %}">
      {% if data.ip_hold_lot %}
        <img src="{% static 'assets/icons/view2.png' %}" alt="Remark" style="width:18px; height:18px;" />
      {% endif %}
    </span>
    <span class="sno-value">{{ forloop.counter }}</span>
  </span>
</td>
                     <td style="color: {{ reason.row_color }};">{{ reason.rejection_reason_id }}</td>
                     <td style="color: {{ reason.row_color }};">{{ reason.rejection_reason }}</td>
                     <td>
                       <input type="number" min="0" class="form-control rejection-qty-input" name="quantity_{{ forloop.counter }}" style="width: 80px;" />
                     </td>
                     <td>
                       <input type="text" class="form-control tray-id-input" name="tray_{{ forloop.counter }}" placeholder="Scan Tray ID" style="width: 120px;" data-group="{{ reason.group.group_name|default:'' }}" />
                       <span class="tray-id-error" style="color: #d32f2f; font-size: 12px; display: none; margin-left: 4px;"></span>
                     </td>
                   </tr>
                 {% endfor %}
                 <tr>
                   <td colspan="3" style="text-align: right; font-weight: bold;">Total Qty</td>
                   <td id="rejection-total-qty" style="font-weight: bold;">0</td>
                   <td></td>
                 </tr>
               </tbody>
            </table>
          </div>
          <!-- "No of Trays" table -->
  <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 10px;">
  <h4 class="mb-0 mt-4">Rejection List Tray Scan</h4>
  <div style="display: flex; align-items: center; gap: 10px;">
    <!-- Redo Icon -->
    <img src="{% static 'assets/icons/redo2.png' %}" alt="Redo" style="width: 24px; height: 24px; cursor: pointer;" title="Clear Tray IDs" />
    <!-- Scan Qty Button -->
    <div style="display: flex; align-items: center; gap: 8px; background: #f8f9fa; padding: 6px 12px; border-radius: 20px; border: 1px solid #dee2e6;">
      <span style="font-size: 14px; font-weight: 600; color: #028084;">Scan Qty:</span>
      <span style="font-size: 14px; font-weight: bold; color: #dc3545;">10/10</span>
    </div>
  </div>
</div>

  <div class="table-responsive" style="border: solid 1px black; margin-top: 10px;">
    <table class="table table-bordered text-center" style="border: solid 2px black; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
      <thead style="border: solid 2px black; background-color: #007bff; color: #fff;">
        <tr>
          <th style="padding: 12px;">S.No</th>
          <th style="padding: 12px;">Tray ID</th>
          <th style="padding: 12px;">Tray Qty</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>1</td>
          <td>TRAY001</td>
          <td>50</td>
        </tr>
        <tr>
          <td>2</td>
          <td>TRAY002</td>
          <td>30</td>
        </tr>
        <tr>
          <td>3</td>
          <td>TRAY003</td>
          <td>20</td>
        </tr>
      </tbody>
    </table>
  </div>

           <br>
           <div id="batchRejectionMsg" style="margin-bottom:10px; color: #d32f2f; font-weight: bold;"></div>
         
            <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
              <button id="draftButton" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 30px;">
                       Draft
                     </button>       
              <button id="proceedButton" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 30px;">
                       Proceed
                     </button>
                     <button style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 30px;">
                       Cancel
                     </button>
                   </div>
            
          `;

        // Add all the existing event listeners for the editable form
        addEditableFormEventListeners(row, batchId, stockLotId);
      }

      // Function to add event listeners for editable form
      function addEditableFormEventListeners(row, batchId, stockLotId) {
        // Place the tray ID validation code here:
        document.querySelectorAll('.tray-id-input').forEach(function(input, idx, allInputs) {
          input.addEventListener('blur', function() {
            const trayId = input.value.trim();
            const group = input.getAttribute('data-group');
            const errorSpan = input.parentElement.querySelector('.tray-id-error') || (() => {
              const span = document.createElement('span');
              span.className = 'tray-id-error';
              span.style.color = 'red';
              span.style.fontSize = '12px';
              input.parentElement.appendChild(span);
              return span;
            })();
            errorSpan.textContent = '';
            errorSpan.style.display = 'none';
        
            if (!trayId) return;
        
            // Check for duplicate tray ID in other rows
            let found = false;
            allInputs.forEach(function(otherInput, otherIdx) {
              if (otherIdx !== idx && otherInput.value.trim() === trayId) {
                const otherGroup = otherInput.getAttribute('data-group');
                if (otherGroup !== group) {
                  errorSpan.textContent = `Tray ID "${trayId}" is not same group match.`;
                  errorSpan.style.display = 'inline';
                  found = true;
                }
              }
            });
            if (found) return;
        
            // Server check for existence (optional, if you want to keep it)
            fetch(`/inputscreening/reject_check_tray_id/?tray_id=${encodeURIComponent(trayId)}`)
              .then(res => res.json())
              .then(data => {
                if (!data.exists) {
                  errorSpan.textContent = `Tray ID "${trayId}" is not existing.`;
                  errorSpan.style.display = 'inline';
                }
              });
          });
        });
        
        // Set availableQty from Django context (set this variable in your view and template)
        const availableQty = parseInt(row.getAttribute('data-available-qty'), 10) || 0;        
        document.querySelectorAll('.rejection-qty-input').forEach(function(input, idx, allInputs) {
          input.addEventListener('input', function() {
            // Remove all previous qty errors
            document.querySelectorAll('.qty-error').forEach(function(span) { span.remove(); });
        
            let total = 0;
            let errorRow = null;
            let errorInput = null;
        
            // Calculate running total and find the first row that exceeds
            allInputs.forEach(function(qtyInput, i) {
              const val = parseInt(qtyInput.value) || 0;
              total += val;
              if (!errorRow && total > availableQty) {
                errorRow = i + 1;
                errorInput = qtyInput;
              }
            });
        
            document.getElementById('rejection-total-qty').textContent = total;
        
            // Show error below the input if exceeded
            if (errorInput) {
              let errorSpan = document.createElement('span');
              errorSpan.className = 'qty-error';
              errorSpan.style.color = '#d32f2f';
              errorSpan.style.fontSize = '12px';
              errorSpan.style.display = 'block';
              errorSpan.style.marginTop = '2px';
              errorSpan.textContent = `Row ${errorRow}: Quantity exceeds available (${availableQty}).`;
              errorInput.parentElement.appendChild(errorSpan);
            }
          });
        });

        // Batch rejection checkbox event listener
        const batchRejectionCheckbox = document.getElementById("batchRejection");
        const rejectionTableBody = document.getElementById("rejection-table-body");
        
        if (batchRejectionCheckbox && rejectionTableBody) {
          batchRejectionCheckbox.addEventListener("change", function () {
            const inputs = rejectionTableBody.querySelectorAll("input");
            if (this.checked) {
              inputs.forEach(input => {
                input.disabled = true;
                input.value = ""; // Optionally clear values
              });
              document.getElementById('rejection-total-qty').textContent = "0";
            } else {
              inputs.forEach(input => {
                input.disabled = false;
              });
            }
          });
        }
        // Attach event listener for Proceed to open new popup modal
        const proceedButton = document.getElementById("proceedButton");
        const cancelButton = document.getElementById("cancelRejection");

        if (proceedButton) {
  proceedButton.addEventListener("click", () => {
    // If already saved, just open the modal if closed
    if (window.trayRejectionSaved) {
      if (!newPopupModal.classList.contains("open")) {
        newPopupModal.classList.add("open");
      }
      return;
    }
    // Prevent multiple clicks during save
    if (proceedButton.disabled) return;
    proceedButton.disabled = true;
    
    const batchRejectionCheckbox = document.getElementById("batchRejection");
    const msgDiv = document.getElementById("batchRejectionMsg");
    if (msgDiv) msgDiv.textContent = ""; // Clear previous messages

    if (batchRejectionCheckbox && batchRejectionCheckbox.checked) {
      // Batch rejection logic
      const batchId = trayModal.dataset.batchId;
      const lotId = trayModal.dataset.stockLotId;
      const totalQty = document.getElementById('rejection-total-qty').textContent || "0";
      if (!batchId || !lotId) {
        if (msgDiv) msgDiv.textContent = "Batch ID or Lot ID not found.";
        proceedButton.disabled = false;
        return;
      }
      fetch('/inputscreening/batch_rejection/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          batch_id: batchId,
          lot_id: lotId,
          total_qty: totalQty
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          if (msgDiv) {
            msgDiv.style.color = "#388e3c";
            msgDiv.textContent = "Batch rejection saved!";
          }
          // Update UI for batch rejection
          updateUIForBatchRejection(batchId);
          setTimeout(() => {
            trayModal.classList.remove("open");
            if (msgDiv) msgDiv.textContent = "";
            window.location.reload(); // <-- Add this line to reload the page

          }, 1200);
        } else {
          if (msgDiv) {
            msgDiv.style.color = "#d32f2f";
            msgDiv.textContent = data.error || "Failed to save batch rejection";
          }
          proceedButton.disabled = false;
        }
      })
      .catch(() => {
        if (msgDiv) {
          msgDiv.style.color = "#d32f2f";
          msgDiv.textContent = "Network error";
        }
        proceedButton.disabled = false;
      });
    } else {
      // Tray-wise rejection save
      const batchId = trayModal.dataset.batchId;
      const lotId = trayModal.dataset.stockLotId;
      const rows = document.querySelectorAll("#rejection-table-body tr");
      let tray_rejections = [];
      
      rows.forEach(row => {
        // Only process rows that have the input fields (skip summary row)
        const qtyInput = row.querySelector('input.rejection-qty-input');
        const trayInput = row.querySelector('input.tray-id-input');
        if (qtyInput && trayInput) {
          const reason_id = row.querySelectorAll("td")[1].textContent.trim();
          const qty = qtyInput.value.trim();
          const tray_id = trayInput.value.trim();
          if (qty && parseInt(qty) > 0 && tray_id) {
            tray_rejections.push({
              reason_id: reason_id,
              qty: qty,
              tray_id: tray_id
            });
          }
        }
      });
      
      if (!tray_rejections.length) {
        if (msgDiv) {
          msgDiv.style.color = "#d32f2f";
          msgDiv.textContent = "Enter at least one tray qty and tray id.";
        }
        proceedButton.disabled = false;
        return;
      }
      
      fetch('/inputscreening/tray_rejection/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          lot_id: lotId,
          batch_id: batchId,
          tray_rejections: tray_rejections
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // ONLY DISABLE FIELDS HERE ON SUCCESS:
          rows.forEach(row => {
            const qtyInput = row.querySelector('input.rejection-qty-input');
            const trayInput = row.querySelector('input.tray-id-input');
            if (qtyInput) qtyInput.disabled = true;
            if (trayInput) trayInput.disabled = true;
          });
          window.trayRejectionSaved = true; // Set flag after first save
          
          if (msgDiv) {
            msgDiv.style.color = "#388e3c";
            msgDiv.textContent = "Tray rejection saved!";
          }
          
          // Fetch and render Accepted Tray Rescan modal
          fetch(`/inputscreening/get_accepted_tray_scan_data/?lot_id=${encodeURIComponent(lotId)}`)
            .then(res => res.json())
            .then(rescanData => {
              if (rescanData.success) {
                showAcceptedTrayModal(rescanData, lotId, rescanData.has_draft || false);
              }
            })
            .catch(error => {
              console.error('Error fetching accepted tray data:', error);
              alert('Error loading accepted tray data. Please try again.');
            });
            
        } else {
          if (msgDiv) {
            msgDiv.style.color = "#d32f2f";
            msgDiv.textContent = data.error || "Failed to save tray rejection";
          }
          proceedButton.disabled = false;
        }
      })
      .catch(() => {
        if (msgDiv) {
          msgDiv.style.color = "#d32f2f";
          msgDiv.textContent = "Network error";
        }
        proceedButton.disabled = false;
      });
    }
  });
}

if (cancelButton) {
  cancelButton.addEventListener("click", () => {
    trayModal.classList.remove("open");
  });
}

// Helper function to update UI for batch rejection
function updateUIForBatchRejection(batchId) {
  const mainRow = document.querySelector(`tr[data-batch-id="${batchId}"]`);
  if (mainRow) {
    // 1. Disable Edit and Delete buttons (show as grayed out)
    const actionTd = mainRow.cells[16]; // 17th column, index 16
    if (actionTd) {
      actionTd.innerHTML = `
        <span title="Edit Disabled" style="opacity: 0.5; pointer-events: none;">
          <img src="/static/assets/icons/edit1.png" alt="Edit Disabled" style="width: 20px; margin-right: 8px; height: auto; filter: grayscale(1) opacity(0.5);" />
        </span>
        <span title="Delete Disabled" style="opacity: 0.5; pointer-events: none;">
          <img src="/static/assets/icons/bin.png" alt="Delete Disabled" style="width: 20px; margin-right: 8px; height: auto; filter: grayscale(1) opacity(0.5);" />
        </span>
        <span class="btn btn-social-icon-text btn-twitter"
              style="background-color: #66bb6a; pointer-events: none; opacity: 0.8; cursor: not-allowed;">
          <i class="fa fa-check-circle"></i>Accept
        </span>
        <span class="btn btn-social-icon-text btn-youtube"
              style="background-color: #e57373; pointer-events: none; opacity: 0.8; cursor: not-allowed;">
          <i class="fa fa-times-circle"></i>Rejected
        </span>
      `;
    }

    // 2. Set Process Status S icon to green
    const processIcons = mainRow.querySelectorAll('.d-flex > div');
    if (processIcons.length > 1) {
      processIcons[1].style.backgroundColor = '#0c8249'; // S icon green
    }

    // 3. Set Lot Status to "Yet to Release"
    const batchStatusTd = mainRow.cells[17]; // 18th column, index 17
    if (batchStatusTd) {
      batchStatusTd.innerHTML = `
        <div class="d-inline-block px-3 fw-semibold text-center rounded-pill"
            style="border: 2px solid #0d5d17; background-color: #c5f9c2; color: #2f801b; font-size: clamp(0.3rem, 2vw, 0.875rem); white-space: nowrap; padding: 0.3rem;">
          Yet to Release
        </div>
      `;
    }

    // 4. Set Current Stage to "Input screening"
    const currentLocationTd = mainRow.cells[18]; // 19th column, index 18
    if (currentLocationTd) {
      currentLocationTd.innerHTML = `
        <div class="d-inline-block px-3 fw-semibold text-center rounded-pill"
            style="border: 2px solid #f9a825; background-color: #fff8e1; color: #b26a00; font-size: clamp(0.75rem, 2vw, 0.875rem); white-space: nowrap; padding-top: 0.5rem; padding-bottom: 0.5rem;">
          Input screening
        </div>
      `;
    }

    // 5. Disable audio and remark icons
    const audioIcon = mainRow.querySelector('a[title="Add Audio Remark"]');
    if (audioIcon) {
      const span = document.createElement('span');
      span.title = "Disabled after moved";
      span.style = "display: inline-flex; align-items: center; height: 28px; margin-left: 0; opacity: 0.5; pointer-events: none;";
      span.innerHTML = audioIcon.innerHTML;
      audioIcon.replaceWith(span);
    }
    const chatIcon = mainRow.querySelector('a[title="Add Remark"]');
    if (chatIcon) {
      const span = document.createElement('span');
      span.title = "Disabled after moved";
      span.style = "display: inline-flex; align-items: center; height: 20px; margin-left: 5px; opacity: 0.5; pointer-events: none;";
      span.innerHTML = chatIcon.innerHTML;
      chatIcon.replaceWith(span);
    }
    const textarea = mainRow.querySelector('textarea');
    if (textarea) textarea.setAttribute('readonly', true);
    const sendBtn = mainRow.querySelector('.remark-tooltip button');
    if (sendBtn) sendBtn.style.display = 'none';
  }
}
        
        if (cancelButton) {
          cancelButton.addEventListener("click", () => {
            trayModal.classList.remove("open");
          });
        }
      }

      // Existing modal close event listeners
      closeTrayBtn.addEventListener("click", () => {
        trayModal.classList.remove("open");
      });
      
      trayModal.addEventListener("click", (event) => {
        if (event.target === trayModal) {
          trayModal.classList.remove("open");
        }
      });
      
      // New Popup Modal close events
      closeNewPopupBtn.addEventListener("click", () => {
        newPopupModal.classList.remove("open");
      });
     
    });
  </script>

<script nonce="{{ csp_nonce }}">
    document.addEventListener("DOMContentLoaded", function () {
      var triggers = document.querySelectorAll(".remark-tooltip-trigger");
      triggers.forEach(function (trigger) {
        var tooltip = trigger.querySelector(".remark-tooltip");
        var sendButton = tooltip ? tooltip.querySelector("button") : null;
        function showTooltip() {
          tooltip.style.opacity = "1";
          tooltip.style.visibility = "visible";
          var rect = tooltip.getBoundingClientRect();
          if (rect.right > window.innerWidth) {
            tooltip.style.left = "auto";
            tooltip.style.right = "0";
            tooltip.style.transform = "none";
          }
          if (rect.left < 0) {
            tooltip.style.left = "0";
            tooltip.style.transform = "none";
          }
          var textarea = tooltip.querySelector("textarea");
          if (textarea) {
            textarea.focus();
          }
        }
        function hideTooltip() {
          tooltip.style.opacity = "0";
          tooltip.style.visibility = "hidden";
        }
        trigger.addEventListener("mouseenter", showTooltip);
        trigger.addEventListener("mouseleave", function () {
          setTimeout(function () {
            if (!trigger.matches(":hover") && !tooltip.matches(":hover")) {
              hideTooltip();
            }
          }, 100);
        });
        tooltip.addEventListener("mouseleave", function () {
          setTimeout(function () {
            if (!tooltip.matches(":hover") && !trigger.matches(":hover")) {
              hideTooltip();
            }
          }, 100);
        });
        trigger.addEventListener("click", function (e) {
          e.preventDefault();
        });
        if (sendButton) {
          sendButton.addEventListener("click", function (e) {
            e.preventDefault();
            // Find the textarea and get its value
            var textarea = tooltip.querySelector("textarea");
            var remark = textarea ? textarea.value.trim() : "";
            if (!remark) {
              Swal.fire('Error', 'Please enter a remark before sending.', 'error');
              return;
            }
            // Find the batch_id from the row (tr) data attribute or from a hidden field
            var row = trigger.closest("tr");
            var trayScanLink = row ? row.querySelector('.tray-scan-btn') : null;
            var batchId = row ? row.getAttribute('data-batch-id') : null;
            if (!batchId) {
              Swal.fire('Error', 'Batch ID not found.', 'error');
              return;
            }
            fetch('/inputscreening/save_ip_pick_remark/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
              },
              body: JSON.stringify({
                batch_id: batchId,
                remark: remark
              })
            })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                Swal.fire({
                  icon: 'success',
                  title: 'Remark saved!',
                  timer: 1200,
                  showConfirmButton: false
                }).then(() => {
                  // Make the textarea readonly
                  if (textarea) {
                    textarea.setAttribute("readonly", true);
                  }

                  // Replace send button with info message
                  if (sendButton && tooltip) {
                    const infoDiv = document.createElement("div");
                    infoDiv.style.marginTop = "40px";
                    infoDiv.style.color = "#31708f";
                    infoDiv.style.background = "#d9edf7";
                    infoDiv.style.border = "1px solid #bce8f1";
                    infoDiv.style.borderRadius = "4px";
                    infoDiv.style.padding = "8px 12px";
                    infoDiv.style.fontSize = "10px";
                    infoDiv.style.textAlign = "left";
                    infoDiv.innerHTML = `
                      <i class="fa fa-info-circle" style="margin-right: 6px;"></i>
                      Remark already saved and cannot be edited.
                    `;
                    sendButton.parentNode.replaceChild(infoDiv, sendButton);
                  }

                  hideTooltip(); // optional if you still want to hide the tooltip
                });

              } else {
                Swal.fire('Error', data.error || 'Failed to save remark', 'error');
              }
            })
            .catch(() => {
              Swal.fire('Error', 'Network error', 'error');
            });
          });
        }
      });
    });
</script>

<!-- Active table row highlight -->
<script nonce="{{ csp_nonce }}">
// Row highlight & position swap for tray-scan-btn-Jig (like DP_PickTable.html)
document.addEventListener("DOMContentLoaded", function() {
  // Add highlight style if not present
  if (!document.getElementById('dp-row-action-highlight-style')) {
    var style = document.createElement('style');
    style.id = 'dp-row-action-highlight-style';
    style.innerHTML = `
      .dp-row-action-highlight {
        transition: box-shadow 1.3s;
        background-color: #f0f8ff !important;
        animation: highlightAnimation 2s ease-in-out;
      }
    `;
    document.head.appendChild(style);
  }

  let originalRowIndex = null;
  let movedRow = null;
  let placeholderRow = null;

  document.querySelectorAll('.tray-scan-btn-Jig').forEach(function(link) {
    link.addEventListener('click', function(event) {
      // Remove highlight from all rows
      document.querySelectorAll('tbody tr').forEach(function(row) {
        row.classList.remove('dp-row-action-highlight');
      });
      // Move the clicked row to the top and highlight
      var row = event.target.closest('tr');
      if (row && row.parentNode) {
        const tbody = row.parentNode;
        // Only move if not already at top
        if (tbody.firstElementChild !== row) {
          // If a previous move exists, restore it first
          if (movedRow && placeholderRow && placeholderRow.parentNode) {
            placeholderRow.parentNode.insertBefore(movedRow, placeholderRow);
            placeholderRow.parentNode.removeChild(placeholderRow);
            movedRow.classList.remove('dp-row-action-highlight');
            movedRow = null;
            placeholderRow = null;
            originalRowIndex = null;
          }
          // Store original index and row
          originalRowIndex = Array.from(tbody.children).indexOf(row);
          movedRow = row;
          // Insert a placeholder at the original position
          placeholderRow = document.createElement('tr');
          placeholderRow.style.display = 'none';
          tbody.insertBefore(placeholderRow, tbody.children[originalRowIndex]);
          // Move row to top
          tbody.insertBefore(row, tbody.firstElementChild);
        }
        row.classList.add('dp-row-action-highlight');
      }
    });
  });

  // On modal close, restore row to original position and remove highlight
  var closeBtn = document.getElementById('closeTrayScanModal_DayPlanning');
  if (closeBtn) {
    closeBtn.addEventListener('click', function() {
      if (movedRow && placeholderRow && placeholderRow.parentNode) {
        placeholderRow.parentNode.insertBefore(movedRow, placeholderRow);
        placeholderRow.parentNode.removeChild(placeholderRow);
        movedRow.classList.remove('dp-row-action-highlight');
        movedRow = null;
        placeholderRow = null;
        originalRowIndex = null;
      }
      // Also remove highlight from any row just in case
      document.querySelectorAll('tbody tr').forEach(function(row) {
        row.classList.remove('dp-row-action-highlight');
        row.classList.remove('highlighted-tray-scan');
      });
    });
  }
});
</script>

<!-- /**
  * Script for Hold/Unhold Remark Modal
  * This script handles the modal for adding hold/unhold remarks
  * and updates the table accordingly.
  */ -->
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  let currentHoldCell = null;
  let intendedState = null;
  let lotId = null;

  // Attach batch_id to each row for easy access
  document.querySelectorAll("tbody tr").forEach(function (row) {
    row.setAttribute('data-stock-lot-id', row.getAttribute('data-stock-lot-id') || row.dataset.batchId);
  });

  // Toggle click handler
  document.querySelectorAll('.hold-toggle-btn').forEach(function (btn) {
    btn.addEventListener('click', function (e) {
      e.preventDefault();
      currentHoldCell = btn.closest('td');
      intendedState = btn.checked;
      const row = currentHoldCell.closest('tr');
      lotId = row.getAttribute('data-stock-lot-id');
      document.getElementById('holdRemarkModal').querySelector('h5').textContent =
        intendedState ? 'Unholding Reason' : 'Holding Reason';
      document.getElementById('holdRemarkInput').value = '';
      document.getElementById('holdRemarkError').textContent = '';
      document.getElementById('holdRemarkModal').style.display = 'flex';
      document.getElementById('holdRemarkInput').focus();
    });
  });

  // Save remark and update backend
  document.getElementById('saveHoldRemarkBtn').onclick = function () {
    const remark = document.getElementById('holdRemarkInput').value.trim();
    if (!remark) {
      document.getElementById('holdRemarkError').textContent = 'Remark required!';
      return;
    }
    if (!currentHoldCell || !lotId) return;

    const action = intendedState ? 'unhold' : 'hold';

    fetch('/inputscreening/ip_save_hold_unhold_reason/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        lot_id: lotId,
        remark: remark,
        action: action
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const row = currentHoldCell.closest('tr');
        lotId = row.getAttribute('data-stock-lot-id');
        const toggle = currentHoldCell.querySelector('.hold-toggle-btn');
        const icon = currentHoldCell.querySelector('.hold-remark-icon');

        if (action === 'hold') {
          // Hold the row
          toggle.checked = false;
          row.classList.add('row-inactive');
          row.querySelectorAll('td').forEach((td, idx) => {
            if (idx > 0) {
              td.classList.add('row-inactive-blur');
            } else {
              td.classList.remove('row-inactive-blur');
            }
          });
          if (icon) {
            icon.style.display = 'inline-block';
            icon.innerHTML = `<img src="{% static 'assets/icons/view2.png' %}" alt="Remark" style="width:18px; height:18px;" />`;
            icon.setAttribute('title', 'Holding Reason: ' + remark);
          }
        } else {
          // Unhold the row
          toggle.checked = true;
          row.classList.remove('row-inactive');
          row.querySelectorAll('td').forEach(td => {
            td.classList.remove('row-inactive-blur');
          });
          if (icon) {
            icon.style.display = 'none';
          }
        }

        document.getElementById('holdRemarkModal').style.display = 'none';
        location.reload();
      } else {
        document.getElementById('holdRemarkError').textContent = data.error || 'Failed to save reason!';
      }
    })
    .catch(() => {
      document.getElementById('holdRemarkError').textContent = 'Network error!';
    });
  };

  // Modal close
  document.getElementById('closeHoldRemarkModal').onclick = function () {
    document.getElementById('holdRemarkModal').style.display = 'none';
  };

  // Helper for CSRF
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>


<!-- Script for restrict multiple actions when any modal is open -->
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  function isAnyModalOpen() {
    // Check for any open modal by class or style
    return (
      document.querySelector('.tray-scan-modal.open, .tray-scan-modal-DayPlanning.open, #holdRemarkModal[style*="display: flex"], #holdRemarkModal[style*="display: block"]')
    );
  }

  // Block Tray Scan, View, Edit, Delete when any modal is open
  document.body.addEventListener('click', function(e) {
    if (isAnyModalOpen()) {
      // Block Tray Scan button
      if (
        e.target.closest('.tray-scan-btn') ||
        e.target.closest('.tray-scan-btn-Jig') ||
        e.target.closest('.edit-qty-btn') ||
        (e.target.closest('a[title="Delete"]')) ||
        (e.target.cxlosest('img[alt="Edit"]')) ||
        (e.target.closest('img[alt="Delete"]')) ||
        (e.target.closest('img[alt="View"]'))
      ) {
        e.stopPropagation();
        e.preventDefault();
        return false;
      }
    }
  }, true);
});
</script>
<!-- Script for full-screen image modal -->
<script nonce="{{ csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
  // Remove tooltip functionality and add click-to-modal for Plating Stk No
  document.querySelectorAll('.model-hover-trigger').forEach(function(trigger) {
    const tooltip = trigger.querySelector('.model-image-tooltip');
    
    // Get images from the original element before cloning
    let imageSources = [];
    if (tooltip) {
      const images = tooltip.querySelectorAll('.img-gallery img');
      imageSources = Array.from(images).map(img => img.src);
    }

    // Remove all existing event listeners by cloning the element
    const newTrigger = trigger.cloneNode(true);
    trigger.parentNode.replaceChild(newTrigger, trigger);

    // Add click event for full-screen modal
    newTrigger.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      if (imageSources.length > 0) {
        // Create full-screen image modal
        showFullScreenImageModal(imageSources, 0);
      } else {
        // Fallback: show placeholder or error message
        showFullScreenImageModal(['/static/assets/images/imagePlaceholder.png'], 0);
      }
    });

    // Ensure no hover functionality
    newTrigger.style.cursor = 'pointer';
    const newTooltip = newTrigger.querySelector('.model-image-tooltip');
    if (newTooltip) {
      newTooltip.style.display = 'none !important';
      newTooltip.style.opacity = '0 !important';
      newTooltip.style.visibility = 'hidden !important';
      newTooltip.style.pointerEvents = 'none !important';
    }
  });

  // Function to show full-screen image modal
  function showFullScreenImageModal(imageSources, currentIndex) {
    // Remove any existing modal first
    const existingModal = document.getElementById('fullScreenImageModal');
    if (existingModal) {
      existingModal.remove();
    }

    // Create modal overlay
    const modalOverlay = document.createElement('div');
    modalOverlay.id = 'fullScreenImageModal';
    modalOverlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.9);
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    `;

    // Create image container
    const imageContainer = document.createElement('div');
    imageContainer.style.cssText = `
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      display: flex;
      align-items: center;
      justify-content: center;
    `;

    // Create main image
    const mainImage = document.createElement('img');
    mainImage.style.cssText = `
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    `;
    
    // Add error handling for image loading
    mainImage.onerror = function() {
      this.src = '/static/assets/images/imagePlaceholder.png';
    };
    
    mainImage.src = imageSources[currentIndex];

    // Create close button
    const closeButton = document.createElement('button');
    closeButton.innerHTML = '&times;';
    closeButton.style.cssText = `
      position: absolute;
      top: -15px;
      right: -15px;
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 50%;
      background: #dc3545;
      color: white;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
      transition: all 0.3s ease;
      z-index: 100000;
    `;

    // Create info button
    const infoButton = document.createElement('button');
    infoButton.innerHTML = '<i class="fa fa-info-circle"></i>';
    infoButton.style.cssText = `
      position: absolute;
      top: -15px;
      left: -15px;
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 50%;
      background: #007bff;
      color: white;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
      transition: all 0.3s ease;
      z-index: 100000;
    `;

    // Create navigation buttons if multiple images
    let prevButton, nextButton, imageCounter;
    if (imageSources.length > 1) {
      // Previous button
      prevButton = document.createElement('button');
      prevButton.innerHTML = '&#8249;';
      prevButton.style.cssText = `
        position: absolute;
        left: -60px;
        top: 50%;
        transform: translateY(-50%);
        width: 50px;
        height: 50px;
        border: none;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.9);
        color: #333;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
        z-index: 100000;
      `;

      // Next button
      nextButton = document.createElement('button');
      nextButton.innerHTML = '&#8250;';
      nextButton.style.cssText = `
        position: absolute;
        right: -60px;
        top: 50%;
        transform: translateY(-50%);
        width: 50px;
        height: 50px;
        border: none;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.9);
        color: #333;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
        z-index: 100000;
      `;

      // Image counter
      imageCounter = document.createElement('div');
      imageCounter.style.cssText = `
        position: absolute;
        bottom: -40px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
      `;
      imageCounter.textContent = `${currentIndex + 1} / ${imageSources.length}`;
    }

    // Add hover effects
    closeButton.addEventListener('mouseenter', function() {
      this.style.background = '#c82333';
      this.style.transform = 'scale(1.1)';
    });
    closeButton.addEventListener('mouseleave', function() {
      this.style.background = '#dc3545';
      this.style.transform = 'scale(1)';
    });

    infoButton.addEventListener('mouseenter', function() {
      this.style.background = '#0056b3';
      this.style.transform = 'scale(1.1)';
    });
    infoButton.addEventListener('mouseleave', function() {
      this.style.background = '#007bff';
      this.style.transform = 'scale(1)';
    });

    // Assemble modal
    imageContainer.appendChild(mainImage);
    imageContainer.appendChild(closeButton);
    imageContainer.appendChild(infoButton);

    if (imageSources.length > 1) {
      imageContainer.appendChild(prevButton);
      imageContainer.appendChild(nextButton);
      imageContainer.appendChild(imageCounter);
    }

    modalOverlay.appendChild(imageContainer);
    document.body.appendChild(modalOverlay);

    // Show modal with animation
    setTimeout(() => {
      modalOverlay.style.opacity = '1';
    }, 10);

    // Navigation functionality
    let current = currentIndex;
    
    function updateImage() {
      mainImage.src = imageSources[current];
      mainImage.onerror = function() {
        this.src = '/static/assets/images/imagePlaceholder.png';
      };
      if (imageCounter) {
        imageCounter.textContent = `${current + 1} / ${imageSources.length}`;
      }
    }

    if (prevButton) {
      prevButton.addEventListener('click', function() {
        current = (current - 1 + imageSources.length) % imageSources.length;
        updateImage();
      });
    }

    if (nextButton) {
      nextButton.addEventListener('click', function() {
        current = (current + 1) % imageSources.length;
        updateImage();
      });
    }

    // Close functionality
    function closeModal() {
      modalOverlay.style.opacity = '0';
      setTimeout(() => {
        if (modalOverlay.parentNode) {
          modalOverlay.parentNode.removeChild(modalOverlay);
        }
      }, 300);
    }

    closeButton.addEventListener('click', closeModal);

    // Info button functionality
    infoButton.addEventListener('click', function() {
      alert('Image Viewer\n\n• Click arrows to navigate between images\n• Press ESC or click X to close\n• Click outside image to close');
    });

    // Close on overlay click
    modalOverlay.addEventListener('click', function(e) {
      if (e.target === modalOverlay) {
        closeModal();
      }
    });

    // Keyboard navigation
    function handleKeyDown(e) {
      switch(e.key) {
        case 'Escape':
          closeModal();
          break;
        case 'ArrowLeft':
          if (prevButton) {
            current = (current - 1 + imageSources.length) % imageSources.length;
            updateImage();
          }
          break;
        case 'ArrowRight':
          if (nextButton) {
            current = (current + 1) % imageSources.length;
            updateImage();
          }
          break;
      }
    }

    document.addEventListener('keydown', handleKeyDown);

    // Cleanup on close
    modalOverlay.addEventListener('transitionend', function() {
      if (modalOverlay.style.opacity === '0') {
        document.removeEventListener('keydown', handleKeyDown);
      }
    });
  }
});
</script>
<!-- Script for tooltips and hover functionality -->
<script nonce="{{ csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
  // Handle close and info button clicks for tooltips
  document.querySelectorAll('.model-hover-trigger').forEach(function(trigger) {
    const tooltip = trigger.querySelector('.model-image-tooltip');
    
    if (tooltip) {
      // Handle close button click (top-right area)
      tooltip.addEventListener('click', function(e) {
        const rect = this.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        // Close button area (top-right 60px x 60px)
        if (x > rect.width - 60 && y < 60) {
          e.stopPropagation();
          trigger.classList.add('tooltip-closed');
          
          // Remove the class after animation to allow hover again
          setTimeout(() => {
            trigger.classList.remove('tooltip-closed');
          }, 300);
        }
        
        // Info button area (top-left 60px x 60px)
        if (x < 60 && y < 60) {
          e.stopPropagation();
          alert('Image Viewer\n\n• Hover to view full-size image\n• Click X to close\n• Move mouse away to hide');
        }
      });
      
      // Prevent tooltip from closing when clicking on the image
      tooltip.addEventListener('click', function(e) {
        e.stopPropagation();
      });
    }
  });
  
  // Close tooltip when pressing ESC key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      document.querySelectorAll('.model-hover-trigger').forEach(function(trigger) {
        trigger.classList.add('tooltip-closed');
        setTimeout(() => {
          trigger.classList.remove('tooltip-closed');
        }, 300);
      });
    }
  });
  
  // Close tooltip when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.model-hover-trigger')) {
      document.querySelectorAll('.model-hover-trigger').forEach(function(trigger) {
        trigger.classList.add('tooltip-closed');
        setTimeout(() => {
          trigger.classList.remove('tooltip-closed');
        }, 300);
      });
    }
  });
});
</script>
<!-- script for hover functionality without click -->
<script nonce="{{ csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
  // Remove click functionality from Plating Stk No - only keep hover
  document.querySelectorAll('.model-hover-trigger').forEach(function(trigger) {
    const tooltip = trigger.querySelector('.model-image-tooltip');
    
    // Get images from the original element
    let imageSources = [];
    if (tooltip) {
      const images = tooltip.querySelectorAll('.img-gallery img');
      imageSources = Array.from(images).map(img => img.src);
    }

    // Remove all existing event listeners by cloning the element
    const newTrigger = trigger.cloneNode(true);
    trigger.parentNode.replaceChild(newTrigger, trigger);

    // REMOVE CLICK EVENT - Only keep hover functionality
    // Keep cursor as default, not pointer
    newTrigger.style.cursor = 'default';
    
    // Ensure tooltip works on hover only
    const newTooltip = newTrigger.querySelector('.model-image-tooltip');
    if (newTooltip) {
      newTooltip.style.display = 'none';
      newTooltip.style.opacity = '0';
      newTooltip.style.visibility = 'hidden';
      newTooltip.style.pointerEvents = 'none';
    }
    
    // Add hover events back
    newTrigger.addEventListener('mouseenter', function() {
      if (newTooltip) {
        newTooltip.style.display = 'flex';
        newTooltip.style.opacity = '1';
        newTooltip.style.visibility = 'visible';
        newTooltip.style.pointerEvents = 'auto';
      }
    });
    
    newTrigger.addEventListener('mouseleave', function() {
      if (newTooltip) {
        newTooltip.style.display = 'none';
        newTooltip.style.opacity = '0';
        newTooltip.style.visibility = 'hidden';
        newTooltip.style.pointerEvents = 'none';
      }
    });
  });
});
</script>


<!-- Script for model hover functionality with backdrop -->
<script nonce="{{ csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
  // Store original styles - minimal storage needed
  let originalStyles = new Map();
  
  document.querySelectorAll('.model-hover-trigger').forEach(function(trigger) {
    const tooltip = trigger.querySelector('.model-image-tooltip');
    
    trigger.addEventListener('mouseenter', function() {
      // Only handle frozen columns z-index to ensure tooltip appears above
      const frozenElements = document.querySelectorAll(`
        #order-listing th:nth-child(1),
        #order-listing td:nth-child(1),
        #order-listing th:nth-child(3),
        #order-listing td:nth-child(3)
      `);
      
      frozenElements.forEach(function(element) {
        // Store and lower only the z-index, keep position intact
        originalStyles.set(element, {
          zIndex: element.style.zIndex
        });
        element.style.zIndex = '1';
      });
      
      // Show tooltip with highest z-index - no backdrop needed
      if (tooltip) {
        tooltip.style.display = 'flex';
        tooltip.style.opacity = '1';
        tooltip.style.visibility = 'visible';
        tooltip.style.pointerEvents = 'auto';
        tooltip.style.zIndex = '100001'; // Ensure tooltip is above everything
      }
    });
    
    trigger.addEventListener('mouseleave', function() {
      // Restore only z-index values
      originalStyles.forEach(function(styles, element) {
        element.style.zIndex = styles.zIndex || '';
      });
      originalStyles.clear();
      
      // Hide tooltip
      if (tooltip) {
        tooltip.style.display = 'none';
        tooltip.style.opacity = '0';
        tooltip.style.visibility = 'hidden';
        tooltip.style.pointerEvents = 'none';
      }
    });
  });
});
</script>


{% endblock %} {% endblock content %}